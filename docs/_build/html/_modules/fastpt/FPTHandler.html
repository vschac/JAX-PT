

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fastpt.FPTHandler &mdash; FAST-PT 3.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=828ea960"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            FAST-PT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FAST-PT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fastpt.FPTHandler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fastpt.FPTHandler</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastpt</span><span class="w"> </span><span class="kn">import</span> <span class="n">FASTPT</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">log</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<div class="viewcode-block" id="FPTHandler">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FPTHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handler class for FAST-PT that simplifies function calls and result management.</span>
<span class="sd">    </span>
<span class="sd">    This class provides a simplified interface for working with FAST-PT functions,</span>
<span class="sd">    with features including parameter validation, caching of results, saving/loading</span>
<span class="sd">    outputs, and direct access to specific power spectrum terms.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fastpt_instance : FASTPT</span>
<span class="sd">        An initialized FASTPT instance.</span>
<span class="sd">    do_cache : bool, optional</span>
<span class="sd">        Whether to cache function results for repeated calls. Default is False.</span>
<span class="sd">    save_all : str, optional</span>
<span class="sd">        File format to save all results (&#39;txt&#39;, &#39;csv&#39;, or &#39;json&#39;). Default is None.</span>
<span class="sd">    save_dir : str, optional</span>
<span class="sd">        Directory to save results. Default is &#39;outputs&#39; directory in pak_hage location.</span>
<span class="sd">    max_cache_entries : int, optional</span>
<span class="sd">        Maximum number of results to keep in cache. Default is 500.</span>
<span class="sd">    **params : dict</span>
<span class="sd">        Default parameters to use for all function calls.</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from fastpt import FASTPT, FPTHandler</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; k = np.logspace(-3, 1, 200)</span>
<span class="sd">    &gt;&gt;&gt; fpt = FASTPT(k)</span>
<span class="sd">    &gt;&gt;&gt; handler = FPTHandler(fpt, C_window=0.75)</span>
<span class="sd">    &gt;&gt;&gt; P = handler.generate_power_spectra()</span>
<span class="sd">    &gt;&gt;&gt; handler.update_default_params(P=P)</span>
<span class="sd">    &gt;&gt;&gt; P_1loop = handler.get(&#39;P_E&#39;)  # Direct access to the P_E term of fpt.IA_tt</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FPTHandler.__init__">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fastpt_instance</span><span class="p">:</span> <span class="n">FASTPT</span><span class="p">,</span> <span class="n">do_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">save_all</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_cache_entries</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fastpt_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You must provide a valid FASTPT instance.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fastpt</span> <span class="o">=</span> <span class="n">fastpt_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_cache</span> <span class="o">=</span> <span class="n">do_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_entries</span> <span class="o">=</span> <span class="n">max_cache_entries</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_all</span> <span class="o">=</span> <span class="n">save_all</span>
        
        <span class="c1"># Set default output directory if none specified</span>
        <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;outputs&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">save_dir</span>
            
        <span class="c1"># Ensure output directory exists</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;You must provide an input power spectrum array&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No power spectrum provided. You&#39;ll need to provide &#39;P&#39; in each function call.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="n">params</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="c1">#Commented out terms have not been implemented yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;P_1loop&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Ps&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pd1d2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>  
            <span class="s2">&quot;Pd2d2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pd1s2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pd2s2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Ps2s2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;sig4&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;sig3nl&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_b3nl&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;Pb1L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pb1L_2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pb1L_b2L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pb2L&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;Pb2L_2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;P_E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_tt&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_E&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_B&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_tt&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_B&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
        
            <span class="s2">&quot;P_A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_mix&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_A&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_Btype2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_mix&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_DEE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_mix&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_DEE&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_DBB&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_mix&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_DBB&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
        
            <span class="s2">&quot;P_deltaE1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_deltaE1&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_deltaE2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ta&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_0E0E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_0E0E&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_0B0B&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_0B0B&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="c1"># &quot;P_gb2sij&quot;: (&quot;IA_gb2&quot;, &quot;X_IA_gb2_F2&quot;, lambda x: 2 * x),</span>
            <span class="c1"># &quot;P_gb2dsij&quot;: (&quot;IA_gb2&quot;, &quot;X_IA_gb2_fe&quot;, lambda x: 2 * x),</span>
            <span class="c1"># &quot;P_gb2sij2&quot;: (&quot;IA_gb2&quot;, &quot;X_IA_gb2_he&quot;, lambda x: 2 * x),</span>

            <span class="s2">&quot;P_der&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_der&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>

            <span class="s2">&quot;P_0tE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_0EtE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_E2tE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_tEtE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;IA_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;P_d2tE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;P_s2tE&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ct&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;P_s2E2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_tt&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_S2he&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_d2E2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_tt&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_he&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
        
            <span class="s2">&quot;P_d2E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_F2&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_d20E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_fe&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_s2E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_S2F2&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
            <span class="s2">&quot;P_s20E&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;gI_ta&quot;</span><span class="p">,</span> <span class="s2">&quot;X_IA_gb2_S2fe&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span>
        
            <span class="s2">&quot;P_OV&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;OV&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        
            <span class="s2">&quot;P_kP1&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;kPol&quot;</span><span class="p">,</span> <span class="s2">&quot;X_kP1&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s2">&quot;P_kP2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;kPol&quot;</span><span class="p">,</span> <span class="s2">&quot;X_kP2&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">160</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="s2">&quot;P_kP3&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;kPol&quot;</span><span class="p">,</span> <span class="s2">&quot;X_kP3&quot;</span><span class="p">,</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)),</span>
        
            <span class="c1"># &quot;A1&quot;: (&quot;RSD_components&quot;, 0),</span>
            <span class="c1"># &quot;A3&quot;: (&quot;RSD_components&quot;, 1),</span>
            <span class="c1"># &quot;A5&quot;: (&quot;RSD_components&quot;, 2),</span>
            <span class="c1"># &quot;B0&quot;: (&quot;RSD_components&quot;, 3),</span>
            <span class="c1"># &quot;B2&quot;: (&quot;RSD_components&quot;, 4),</span>
            <span class="c1"># &quot;B4&quot;: (&quot;RSD_components&quot;, 5),</span>
            <span class="c1"># &quot;B6&quot;: (&quot;RSD_components&quot;, 6),</span>
            <span class="c1"># &quot;P_Ap1&quot;: (&quot;RSD_components&quot;, 7),</span>
            <span class="c1"># &quot;P_Ap3&quot;: (&quot;RSD_components&quot;, 8),</span>
            <span class="c1"># &quot;P_Ap5&quot;: (&quot;RSD_components&quot;, 9),</span>
        
            <span class="c1"># &quot;ABsum_mu2&quot;: (&quot;RSD_ABsum_components&quot;, 0),</span>
            <span class="c1"># &quot;ABsum_mu4&quot;: (&quot;RSD_ABsum_components&quot;, 1),</span>
            <span class="c1"># &quot;ABsum_mu6&quot;: (&quot;RSD_ABsum_components&quot;, 2),</span>
            <span class="c1"># &quot;ABsum_mu8&quot;: (&quot;RSD_ABsum_components&quot;, 3),</span>
        
            <span class="c1"># &quot;ABsum&quot;: (&quot;RSD_ABsum_components&quot;, 0),</span>

            <span class="c1"># &quot;P_IRres&quot;: (&quot;IRres&quot;, 0),</span>
        <span class="p">}</span></div>

 
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fastpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the underlying FASTPT instance.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FASTPT</span>
<span class="sd">            The FASTPT instance used by this handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fastpt</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_function_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Returns both required and optional parameter names for a given FASTPT function. &quot;&quot;&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">required_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">optional_params</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip self parameter and *args/**kwargs</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span> <span class="ow">or</span> 
                <span class="n">param</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">)):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="o">==</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">required_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optional_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="n">required_params</span><span class="p">,</span>
            <span class="s1">&#39;optional&#39;</span><span class="p">:</span> <span class="n">optional_params</span><span class="p">,</span>
            <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="n">required_params</span> <span class="o">+</span> <span class="n">optional_params</span>
        <span class="p">}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Stores results uniquely by function name and its specific parameters. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_entries</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max cache size reached. Removing oldest entry.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)))</span>
        <span class="n">hashable_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_hashable</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">hashable_params</span><span class="p">)]</span> <span class="o">=</span> <span class="n">result</span>
    

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_hashable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert parameters to hashable format, handling numpy arrays specially&quot;&quot;&quot;</span>
        <span class="n">hashable_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">hashable_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hashable_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">hashable_params</span><span class="p">))</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_function_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepares and validates parameters for a FASTPT function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">override_kwargs</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="o">**</span><span class="n">override_kwargs</span><span class="p">)</span>
    
        <span class="n">merged_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">}</span>

        <span class="n">params_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_function_params</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">missing_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params_info</span><span class="p">[</span><span class="s1">&#39;required&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_params</span><span class="p">]</span>
    
        <span class="k">if</span> <span class="n">missing_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required parameters for &#39;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">missing_params</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;Please recall with the missing parameters.&quot;</span><span class="p">)</span>

        <span class="c1"># Return only the params the function actually needs</span>
        <span class="n">passing_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">merged_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">params_info</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">passing_params</span><span class="p">,</span> <span class="n">params_info</span>


<div class="viewcode-block" id="FPTHandler.run">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">save_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a FAST-PT function with validated parameters.</span>
<span class="sd">        </span>
<span class="sd">        This method calls the specified FAST-PT function, handles parameter validation,</span>
<span class="sd">        caches results if enabled, and optionally saves the output to a file.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        function_name : str</span>
<span class="sd">            Name of the FAST-PT function to run</span>
<span class="sd">        save_type : str, optional</span>
<span class="sd">            File format to save results (&#39;txt&#39;, &#39;csv&#39;, or &#39;json&#39;)</span>
<span class="sd">        save_dir : str, optional</span>
<span class="sd">            Directory to save results. Defaults to the class&#39;s output_dir.</span>
<span class="sd">        **override_kwargs : dict</span>
<span class="sd">            Additional parameters to pass to the FAST-PT function</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : object</span>
<span class="sd">            Result from the FAST-PT function call, typically a tuple of numpy arrays</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the function is not found or parameter validation fails</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop_result = handler.run(&#39;one_loop_dd&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ia_result = handler.run(&#39;IA_tt&#39;, save_type=&#39;csv&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39; not found in FASTPT.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;save_type&#39;</span> <span class="ow">in</span> <span class="n">override_kwargs</span><span class="p">:</span>
            <span class="n">save_param</span> <span class="o">=</span> <span class="n">override_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">save_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_type</span> <span class="o">=</span> <span class="n">save_param</span>
                
        <span class="k">if</span> <span class="s1">&#39;save_dir&#39;</span> <span class="ow">in</span> <span class="n">override_kwargs</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">override_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;save_dir&#39;</span><span class="p">)</span>

        <span class="n">output_directory</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>

        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
        <span class="n">passing_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_function_params</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">override_kwargs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_cache</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_hashable</span><span class="p">(</span><span class="n">passing_params</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cache_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using cached result for </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">passing_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_cache</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache_result</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="n">passing_params</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">save_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">save_type</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_all</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">save_output</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_all</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">output_directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    
<div class="viewcode-block" id="FPTHandler.bulk_run">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.bulk_run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bulk_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_names</span><span class="p">,</span> <span class="n">power_spectra</span><span class="p">,</span> <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run multiple functions with multiple power spectra.</span>
<span class="sd">        </span>
<span class="sd">        This method provides a convenient way to run multiple FAST-PT functions</span>
<span class="sd">        with different power spectra and collect all the results.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func_names : list of str</span>
<span class="sd">            List of FAST-PT function names to call</span>
<span class="sd">        power_spectra : list of array_like</span>
<span class="sd">            List of power spectra to use for each function call</span>
<span class="sd">        flip : bool, optional</span>
<span class="sd">            Whether to run each function at every power spectrum or every power spectrum at each function</span>
<span class="sd">            (Default is False, which runs each function at every power spectrum)</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print progress messages</span>
<span class="sd">        **override_kwargs : dict</span>
<span class="sd">            Additional parameters to pass to all function calls</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Results keyed by (function_name, power_spectrum_index)</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; k = np.logspace(-3, 1, 200)</span>
<span class="sd">        &gt;&gt;&gt; P1 = k**(-1.5)  # Example power spectrum 1</span>
<span class="sd">        &gt;&gt;&gt; P2 = k**(-1.0)  # Example power spectrum 2</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; results = handler.bulk_run([&#39;one_loop_dd&#39;, &#39;IA_tt&#39;], [P1, P2])</span>
<span class="sd">        &gt;&gt;&gt; one_loop_P1 = results[(&#39;one_loop_dd&#39;, 0)]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">power_spectra</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">func_names</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">P</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> with power spectrum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">func_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">P</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">power_spectra</span><span class="p">):</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">P</span><span class="p">}</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> with power spectrum </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

       
<div class="viewcode-block" id="FPTHandler.get">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">terms</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get specific power spectrum terms directly.</span>
<span class="sd">        </span>
<span class="sd">        This method provides direct access to specific power spectrum components</span>
<span class="sd">        without needing to know which FAST-PT function calculates them.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *terms : str</span>
<span class="sd">            Names of power spectrum terms to retrieve</span>
<span class="sd">        **override_kwargs : dict</span>
<span class="sd">            Parameters for the underlying FAST-PT calculations</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        term or dict</span>
<span class="sd">            If a single term is requested, returns that term directly.</span>
<span class="sd">            If multiple terms are requested, returns a dictionary mapping</span>
<span class="sd">            term names to their values.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If a requested term is not found or parameters are invalid</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop = handler.get(&#39;P_1loop&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ia_terms = handler.get(&#39;P_E&#39;, &#39;P_B&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">terms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one term must be provided.&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">unique_funcs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;P_Btype2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_Btype2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_deltaE2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_deltaE2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_der&quot;</span><span class="p">:</span> <span class="s2">&quot;IA_der&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_OV&quot;</span><span class="p">:</span> <span class="s2">&quot;OV&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_0tE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_0tE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_0EtE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_0EtE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_E2tE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_E2tE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_tEtE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_tEtE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_1loop&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_1loop&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Ps&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Ps&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pd1d2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pd1d2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pd2d2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pd2d2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pd1s2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pd1s2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pd2s2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pd2s2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Ps2s2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Ps2s2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sig4&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_sig4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sig3nl&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_sig3nl&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pb1L&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pb1L&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pb1L_2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pb1L_2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pb1L_b2L&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pb1L_b2L&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pb2L&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pb2L&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Pb2L_2&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_Pb2L_2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_d2tE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_d2tE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;P_s2tE&quot;</span><span class="p">:</span> <span class="s2">&quot;_get_P_s2tE&quot;</span>
                <span class="p">}</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Term &#39;</span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&#39; not found in FASTPT.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">unique_funcs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1">#Terms that have their own unique functions</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="n">unique_funcs</span><span class="p">[</span><span class="n">term</span><span class="p">]</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
            
                <span class="n">passing_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_function_params</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">override_kwargs</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">passing_params</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span>
                <span class="n">passing_params</span><span class="p">,</span> <span class="n">params_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_function_params</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">override_kwargs</span><span class="p">)</span>

                <span class="n">compute_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="s2">&quot;compute_term&quot;</span><span class="p">)</span>

                <span class="n">X_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span><span class="p">[</span><span class="n">term</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="c1"># Handle case where we need multiple X terms (like for ctbias)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_source</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">X_names</span> <span class="o">=</span> <span class="n">X_source</span>
                    <span class="n">X_terms</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">X_names</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">):</span>
                            <span class="n">X_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in FASTPT&quot;</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">compute_func</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">X_terms</span><span class="p">),</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">passing_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Standard case with a single X tracer</span>
                    <span class="n">X_term</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">X_source</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">compute_func</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">X_term</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="n">operation</span><span class="p">,</span> <span class="o">**</span><span class="n">passing_params</span><span class="p">)</span>                
                
            <span class="n">output</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># If only one term was requested, return just that value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">output</span></div>

    
<div class="viewcode-block" id="FPTHandler.get_tracer">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.get_tracer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tracer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracer_name</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Fast-PT terms relevant to a specific tracer.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tracer_name : str</span>
<span class="sd">            Name of tracer terms to retrieve</span>
<span class="sd">        **override_kwargs : dict</span>
<span class="sd">            Parameters for the underlying FAST-PT calculations</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Returns a dictionary of key-value pairs where the key is the term name</span>
<span class="sd">            and the value is the calculated term from Fast-PT.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If a requested tracer is not found or parameters are invalid</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">            Some terms have different names in FAST-PT than in CCL, see the &quot;aliases&quot; dictionary.</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop = handler.get(&#39;pgm&#39;)</span>
<span class="sd">        &gt;&gt;&gt; #returns Pd1d2, Pd1s2, Pd1p3 (sig3nl)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1">#Names used in CCL for FASTPT terms</span>

            <span class="s2">&quot;Pd1p3&quot;</span> <span class="p">:</span> <span class="s2">&quot;sig3nl&quot;</span><span class="p">,</span>

            <span class="s2">&quot;a00e&quot;</span><span class="p">:</span> <span class="s2">&quot;P_deltaE1&quot;</span><span class="p">,</span> <span class="s2">&quot;c00e&quot;</span><span class="p">:</span> <span class="s2">&quot;P_deltaE2&quot;</span><span class="p">,</span> <span class="s2">&quot;a0e2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;b0e2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_Btype2&quot;</span><span class="p">,</span> <span class="s2">&quot;tijsij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_0tE&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2tij&quot;</span><span class="p">:</span> <span class="s2">&quot;P_d2tE&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;s2tij&quot;</span><span class="p">:</span> <span class="s2">&quot;P_s2tE&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2sij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_d2E&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2dsij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_d20E&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2sij2&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_d2E2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;s2sij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_s2E&quot;</span><span class="p">,</span> <span class="s2">&quot;s2dsij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_s20E&quot;</span><span class="p">,</span> <span class="s2">&quot;s2sij2&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_s2E2&quot;</span><span class="p">,</span>

            <span class="s2">&quot;a0e0e&quot;</span><span class="p">:</span> <span class="s2">&quot;P_0E0E&quot;</span><span class="p">,</span> <span class="s2">&quot;a0b0b&quot;</span><span class="p">:</span> <span class="s2">&quot;P_0B0B&quot;</span><span class="p">,</span> <span class="s2">&quot;ae2e2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_E&quot;</span><span class="p">,</span> <span class="s2">&quot;ab2b2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;a0e2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_A&quot;</span><span class="p">,</span> <span class="s2">&quot;b0e2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_Btype2&quot;</span><span class="p">,</span> <span class="s2">&quot;d0ee2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_DEE&quot;</span><span class="p">,</span> <span class="s2">&quot;d0bb2&quot;</span><span class="p">:</span> <span class="s2">&quot;P_dDBB&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tijdsij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_0EtE&quot;</span><span class="p">,</span> <span class="s2">&quot;tij2sij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_E2tE&quot;</span><span class="p">,</span> <span class="s2">&quot;tijtij&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_tEtE&quot;</span><span class="p">,</span> <span class="s2">&quot;Pak2&quot;</span> <span class="p">:</span> <span class="s2">&quot;P_der&quot;</span><span class="p">,</span> <span class="c1">#&lt;&lt; Sometimes der sometimes non fpt term?</span>

        <span class="p">}</span>
        <span class="n">tracer_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pgg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Pd1d2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd2d2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd1s2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd2s2&quot;</span><span class="p">,</span> <span class="s2">&quot;Ps2s2&quot;</span><span class="p">,</span><span class="s2">&quot;Pd1p3&quot;</span><span class="p">),</span> 
            <span class="c1">#^^ also needs Pd1d1 and Pd1k2</span>
            <span class="s2">&quot;pgi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;a00e&quot;</span><span class="p">,</span> <span class="s2">&quot;c00e&quot;</span><span class="p">,</span> <span class="s2">&quot;a0e2&quot;</span><span class="p">,</span> <span class="s2">&quot;b0e2&quot;</span><span class="p">,</span> <span class="s2">&quot;tijsij&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2tij&quot;</span><span class="p">,</span> <span class="s2">&quot;s2tij&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;gb2sij&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2dsij&quot;</span><span class="p">,</span> <span class="s2">&quot;gb2sij2&quot;</span><span class="p">,</span> <span class="s2">&quot;s2sij&quot;</span><span class="p">,</span> <span class="s2">&quot;s2dsij&quot;</span><span class="p">,</span> <span class="s2">&quot;s2sij2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sig3nl&quot;</span><span class="p">),</span>
            <span class="c1">#^^ also needs Pd1d1</span>
            <span class="s2">&quot;pgm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Pd1d2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd1s2&quot;</span><span class="p">,</span> <span class="s2">&quot;Pd1p3&quot;</span><span class="p">),</span>
            <span class="c1">#^^ also needs Pd1d1 and Pd1k2</span>
            <span class="s2">&quot;pii&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;a00e&quot;</span><span class="p">,</span> <span class="s2">&quot;c00e&quot;</span><span class="p">,</span> <span class="s2">&quot;a0e0e&quot;</span><span class="p">,</span> <span class="s2">&quot;a0b0b&quot;</span><span class="p">,</span> <span class="s2">&quot;ae2e2&quot;</span><span class="p">,</span> <span class="s2">&quot;ab2b2&quot;</span><span class="p">,</span> <span class="s2">&quot;a0e2&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;b0e2&quot;</span><span class="p">,</span> <span class="s2">&quot;d0ee2&quot;</span><span class="p">,</span> <span class="s2">&quot;d0bb2&quot;</span><span class="p">,</span> <span class="s2">&quot;tijsij&quot;</span><span class="p">,</span> <span class="s2">&quot;tijdsij&quot;</span><span class="p">,</span> <span class="s2">&quot;tij2sij&quot;</span><span class="p">,</span> <span class="s2">&quot;tijtij&quot;</span><span class="p">,</span> <span class="s2">&quot;Pak2&quot;</span><span class="p">),</span>
            <span class="c1">#^^ also needs Pd1d1, Pak2 has a weird if chek_h</span>
            <span class="s2">&quot;pim&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;a00e&quot;</span><span class="p">,</span> <span class="s2">&quot;c00e&quot;</span><span class="p">,</span> <span class="s2">&quot;a0e2&quot;</span><span class="p">,</span> <span class="s2">&quot;b0e2&quot;</span><span class="p">,</span> <span class="s2">&quot;tijsij&quot;</span><span class="p">,</span> <span class="s2">&quot;Pak2&quot;</span><span class="p">),</span>
            <span class="c1">#^^ also needs Pd1d1, Pak2 has a weird if chek_h</span>
            <span class="s2">&quot;pmm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;P_1loop&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">tracer_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tracer_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tracer &#39;</span><span class="si">{</span><span class="n">tracer_name</span><span class="si">}</span><span class="s2">&#39; not currently supported. Available tracers are: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">tracer_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">tracer_map</span><span class="p">[</span><span class="n">tracer_name</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">calc_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;not found in FASTPT&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                        <span class="n">calc_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aliases</span><span class="p">[</span><span class="n">term</span><span class="p">],</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="n">result</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_term</span>
        <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="FPTHandler.clear_cache">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.clear_cache">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear cached function results.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        function_name : str, optional</span>
<span class="sd">            If provided, only clears cache for the specified function.</span>
<span class="sd">            If None, clears the entire cache.</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, do_cache=True)</span>
<span class="sd">        &gt;&gt;&gt; handler.run(&#39;one_loop_dd&#39;, P=P_linear)</span>
<span class="sd">        &gt;&gt;&gt; handler.clear_cache(&#39;one_loop_dd&#39;)  # Clear just one_loop_dd results</span>
<span class="sd">        &gt;&gt;&gt; handler.clear_cache()  # Clear all cached results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">function_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">function_name</span><span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cache cleared for &#39;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cache cleared for all functions.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.show_cache_info">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.show_cache_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">show_cache_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display information about the current cache state.</span>
<span class="sd">        </span>
<span class="sd">        Shows the number of entries in the cache, the maximum allowed entries,</span>
<span class="sd">        and the current usage percentage.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, do_cache=True, max_cache_entries=100)</span>
<span class="sd">        &gt;&gt;&gt; handler.run(&#39;one_loop_dd&#39;, P=P_linear)</span>
<span class="sd">        &gt;&gt;&gt; handler.show_cache_info()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_entries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">({</span>
            <span class="s2">&quot;num_entries&quot;</span><span class="p">:</span> <span class="n">num_entries</span><span class="p">,</span>
            <span class="s2">&quot;max_entries&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_entries</span><span class="p">,</span>
            <span class="s2">&quot;usage_percent&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">num_entries</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_entries</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cache_entries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">})</span></div>



<div class="viewcode-block" id="FPTHandler.list_available_functions">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.list_available_functions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all callable FAST-PT functions.</span>
<span class="sd">        </span>
<span class="sd">        Prints a list of all public functions available in the FAST-PT instance.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; handler.list_available_functions()</span>
<span class="sd">        [&#39;OV&#39;, &#39;IA_ct&#39;, &#39;gI_ct&#39;, &#39;gI_tt&#39;, &#39;IA_der&#39;, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">)</span> <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)])</span></div>


<div class="viewcode-block" id="FPTHandler.list_available_terms">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.list_available_terms">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_available_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List all available power spectrum terms that can be requested via get().</span>
<span class="sd">        </span>
<span class="sd">        Prints available terms organized by the FAST-PT function that calculates them,</span>
<span class="sd">        along with any special parameter requirements.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; handler.list_available_terms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Organize by function</span>
        <span class="n">organized</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">term</span><span class="p">,</span> <span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">term_sources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organized</span><span class="p">:</span>
                <span class="n">organized</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">organized</span><span class="p">[</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        
        <span class="c1"># Print in a nice format</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available terms by function:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">terms</span> <span class="ow">in</span> <span class="n">organized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="n">terms_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">terms_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Special parameter requirements</span>
        <span class="n">special_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;RSD_components&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">],</span>
            <span class="s2">&quot;RSD_ABsum_components&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">],</span>
            <span class="s2">&quot;RSD_ABsum_mu&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;mu_n&quot;</span><span class="p">],</span>
            <span class="s2">&quot;IRres&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;rsdrag&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Special parameter requirements:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">special_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">: requires </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">organized</span></div>

    
<div class="viewcode-block" id="FPTHandler.clear_default_params">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.clear_default_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clear all default parameters.</span>
<span class="sd">        </span>
<span class="sd">        Removes all stored default parameters so they must be specified</span>
<span class="sd">        in subsequent function calls.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; handler.clear_default_params()</span>
<span class="sd">        &gt;&gt;&gt; # Now P must be provided in each function call</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default parameters cleared.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.update_default_params">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.update_default_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the default parameters used for all function calls.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        **params : dict</span>
<span class="sd">            Parameters to set as defaults</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If any parameters are invalid or inconsistent</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; handler.update_default_params(P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; # Now these parameters will be used by default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default parameters updated.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.update_fastpt_instance">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.update_fastpt_instance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_fastpt_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fastpt_instance</span><span class="p">:</span> <span class="n">FASTPT</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the FAST-PT instance used by this handler.</span>
<span class="sd">        </span>
<span class="sd">        This method replaces the current FASTPT instance and clears the cache.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fastpt_instance : FASTPT</span>
<span class="sd">            New FASTPT instance to use</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; k_new = np.logspace(-4, 2, 300)  # Different k range</span>
<span class="sd">        &gt;&gt;&gt; fpt_new = FASTPT(k_new)</span>
<span class="sd">        &gt;&gt;&gt; handler.update_fastpt_instance(fpt_new)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fastpt</span> <span class="o">=</span> <span class="n">fastpt_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FASTPT instance updated. Cache cleared.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.save_output">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.save_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save calculation results to a file.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        result : array_like or tuple of array_like</span>
<span class="sd">            Result to save</span>
<span class="sd">        func_name : str</span>
<span class="sd">            Name of the function that produced the result</span>
<span class="sd">        type : str, optional</span>
<span class="sd">            File format (&#39;txt&#39;, &#39;csv&#39;, or &#39;json&#39;). Default is &#39;txt&#39;.</span>
<span class="sd">        output_dir : str, optional</span>
<span class="sd">            Directory to save the file. Default is the handler&#39;s output_dir.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If an invalid file type is specified</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; result = handler.run(&#39;one_loop_dd&#39;, P=P_linear)</span>
<span class="sd">        &gt;&gt;&gt; handler.save_output(result, &#39;one_loop_dd&#39;, type=&#39;csv&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">):</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid file type. Must be &#39;txt&#39;, &#39;csv&#39;, or &#39;json&#39;&quot;</span><span class="p">)</span>
        
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span><span class="p">,</span> <span class="s2">&quot;one_loop_dd_bias_b3nl&quot;</span><span class="p">,</span> <span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span> <span class="c1"># sig4 is of type float, converting it to np array</span>
                    <span class="n">new_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">new_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_array</span>

        <span class="n">base_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">_output.</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
        
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">_output.</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
                <span class="n">data_for_csv</span> <span class="o">=</span> <span class="p">[]</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data_for_csv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Try to handle as collection of arrays or values</span>
                    <span class="n">transposed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">data_for_csv</span> <span class="o">=</span> <span class="n">transposed</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transposed</span><span class="p">,</span> <span class="s1">&#39;tolist&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">transposed</span>
                
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">))]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">func_name</span><span class="p">]</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">data_for_csv</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                
                <span class="c1"># Prepare data for JSON serialization (numpy arrays aren&#39;t directly JSON serializable)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">numpy_to_python</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                        <span class="k">return</span> <span class="p">[</span><span class="n">numpy_to_python</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">obj</span>
                
                <span class="n">json_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">func_name</span><span class="p">:</span> <span class="n">numpy_to_python</span><span class="p">(</span><span class="n">result</span><span class="p">)}</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonfile</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">jsonfile</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output saved to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> output: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.load">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.load">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">load_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Load a saved output file and return it in the same format as FASTPT outputs (tuple of numpy arrays)</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            file_path (str): Name or path of the file to load</span>
<span class="sd">            load_dir (str, optional): Directory to load file from. If None, uses default output directory</span>
<span class="sd">                                     If file_path already includes a directory, load_dir is ignored.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple of numpy arrays matching the original FASTPT function output format</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; result = handler.run(&#39;one_loop_dd&#39;, save_type=&#39;txt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; loaded_data = handler.load(&#39;one_loop_dd_output.txt&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
        
        <span class="c1"># If file_path is an absolute path or already contains directory info, use it as is</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, build path from load_dir or default output directory</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">load_dir</span> <span class="k">if</span> <span class="n">load_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
        
        <span class="c1"># Get file extension</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
        <span class="c1"># Chek_h for valid extension before chek_hing if file exists</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">. Must be &#39;.txt&#39;, &#39;.csv&#39;, or &#39;.json&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>

        
        <span class="c1"># Extract function name from filename</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.+?)(?:_\d+)?_output\.&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">full_path</span><span class="p">))</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">func_name</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">func_name</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
                <span class="c1"># Load and transpose to match original format</span>
                <span class="n">loaded_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="c1"># Split columns into separate arrays</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">loaded_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loaded_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.csv&quot;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
                    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
                    <span class="c1"># Skip header row</span>
                    <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                    <span class="c1"># Read all rows</span>
                    <span class="n">data_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                    
                    <span class="c1"># Convert to numeric values</span>
                    <span class="n">numeric_data</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_rows</span><span class="p">:</span>
                        <span class="n">numeric_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span>
                    
                    <span class="c1"># Convert to numpy array</span>
                    <span class="n">all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">numeric_data</span><span class="p">)</span>
                    
                    <span class="c1"># Split columns into separate arrays (transposing to match original format)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">all_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
                    
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.json&quot;</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonfile</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span>
                    <span class="c1"># Get the function name from the data if available</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">func_name</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">func_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    
                    <span class="c1"># Get the data under the function name key</span>
                    <span class="n">result_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>
                    
                    <span class="c1"># Handle different possible structures in JSON</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="c1"># If result_data is a list of lists (multiple arrays)</span>
                        <span class="k">if</span> <span class="n">result_data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">result_data</span><span class="p">:</span>
                                <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Single array</span>
                            <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result_data</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Single value or other structure</span>
                        <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">result_data</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported file extension: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">. Must be &#39;.txt&#39;, &#39;.csv&#39;, or &#39;.json&#39;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Handle special case for sig4 in bias functions - convert bak_h to float</span>
            <span class="c1"># In one_loop_dd_bias and one_loop_dd_bias_b3nl, sig4 is at index 7</span>
            <span class="c1"># In one_loop_dd_bias_lpt_NL, sig4 is at index 6</span>
            <span class="k">if</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;one_loop_dd_bias&quot;</span><span class="p">,</span> <span class="s2">&quot;one_loop_dd_bias_b3nl&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="c1"># Chek_h if the array is mostly zeros with one value</span>
                <span class="k">if</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Get the first non-zero value or the first value if all zeros</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">]):</span>
                        <span class="n">sig4_value</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sig4_value</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig4_value</span>
                    
            <span class="k">elif</span> <span class="n">func_name</span> <span class="o">==</span> <span class="s2">&quot;one_loop_dd_bias_lpt_NL&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="c1"># Similar chek_h for lpt_NL case</span>
                <span class="k">if</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">]):</span>
                        <span class="n">sig4_value</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sig4_value</span> <span class="o">=</span> <span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">sig4_value</span>
                    
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output loaded from </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Convert list of arrays to tuple to match FASTPT output format</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading output from </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

        

<div class="viewcode-block" id="FPTHandler.save_params">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.save_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save parameters to a compressed numpy .npz file.</span>
<span class="sd">        </span>
<span class="sd">        This method saves both numpy arrays and other Python objects (strings, floats, ints, etc.)</span>
<span class="sd">        in a single file. Arrays are stored directly, while non-array values are collected</span>
<span class="sd">        in a metadata dictionary and stored as a special array.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Path where parameters will be saved. If the path doesn&#39;t end with &#39;.npz&#39;,</span>
<span class="sd">            the extension will be added automatically.</span>
<span class="sd">        output_dir : str, optional</span>
<span class="sd">            Directory to save parameters. If None, uses default output directory.</span>
<span class="sd">            If filename already contains a directory path, output_dir is ignored.</span>
<span class="sd">        **params : dict</span>
<span class="sd">            Parameters to save. If no parameters are provided, the handler&#39;s default</span>
<span class="sd">            parameters will be saved instead.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Non-array values are stored in a special array with key &#39;__metadata__&#39;.</span>
<span class="sd">        Arrays and scalars can be freely mixed in the parameters.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; # Save specific parameters</span>
<span class="sd">        &gt;&gt;&gt; handler.save_params(&#39;my_params&#39;, P=P_linear, C_window=0.75, bias=1.5)</span>
<span class="sd">        &gt;&gt;&gt; # Save default parameters</span>
<span class="sd">        &gt;&gt;&gt; handler.save_params(&#39;default_params&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Save to specific directory</span>
<span class="sd">        &gt;&gt;&gt; handler.save_params(&#39;custom_params&#39;, output_dir=&#39;/path/to/save&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No parameters stored or provided to save.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">params</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saving default params...&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="n">arrays</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">arrays</span><span class="p">[</span><span class="s1">&#39;__metadata__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">metadata</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="c1"># If filename is absolute, use it directly</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, determine the base directory</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">full_path</span><span class="p">)),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">+=</span> <span class="s1">&#39;.npz&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="o">**</span><span class="n">arrays</span><span class="p">)</span></div>


<div class="viewcode-block" id="FPTHandler.load_params">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.load_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">load_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load parameters from a saved .npz file.</span>
<span class="sd">        </span>
<span class="sd">        Loads both array and non-array parameters from a file created with save_params().</span>
<span class="sd">        Arrays are loaded directly, while scalar values are extracted from the metadata.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Path to the parameter file. If the path doesn&#39;t end with &#39;.npz&#39;,</span>
<span class="sd">            the extension will be added automatically.</span>
<span class="sd">        load_dir : str, optional</span>
<span class="sd">            Directory to load parameters from. If None, uses default output directory.</span>
<span class="sd">            If filename already contains a directory path, load_dir is ignored.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing all loaded parameters.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method automatically handles the separation between array parameters and</span>
<span class="sd">        scalar metadata that was created during saving.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt)</span>
<span class="sd">        &gt;&gt;&gt; params = handler.load_params(&#39;my_params.npz&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(params.keys())</span>
<span class="sd">        &gt;&gt;&gt; # Use loaded parameters in a calculation</span>
<span class="sd">        &gt;&gt;&gt; result = handler.run(&#39;one_loop_dd&#39;, **params)</span>
<span class="sd">        &gt;&gt;&gt; # Load from specific directory</span>
<span class="sd">        &gt;&gt;&gt; params = handler.load_params(&#39;custom_params&#39;, load_dir=&#39;/path/to/load&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">load_dir</span> <span class="k">if</span> <span class="n">load_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">full_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npz&#39;</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">+=</span> <span class="s1">&#39;.npz&#39;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter file &#39;</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;__metadata__&#39;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;__metadata__&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;__metadata__&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="FPTHandler.plot">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
             <span class="n">log_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">label_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> 
             <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a plot of power spectrum terms.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : dict or array-like, optional</span>
<span class="sd">            Data to plot. Can be:</span>
<span class="sd">            - Dictionary mapping labels to arrays (direct plotting)</span>
<span class="sd">            - Result from FAST-PT function call (will be plotted directly)</span>
<span class="sd">            - None (requires &#39;terms&#39; parameter to get data)</span>
<span class="sd">        terms : str or list, optional</span>
<span class="sd">            Term name(s) to plot if data is not provided</span>
<span class="sd">        k : array-like, optional</span>
<span class="sd">            k values for x-axis. If None, uses handler&#39;s FASTPT k values</span>
<span class="sd">        ax : matplotlib.axes.Axes, optional</span>
<span class="sd">            Axes to plot on. If None, creates a new figure</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Plot title</span>
<span class="sd">        log_scale : bool or tuple, optional</span>
<span class="sd">            Whether to use log scale. If True, both axes are log.</span>
<span class="sd">            Can provide (x_log, y_log) tuple to specify each axis</span>
<span class="sd">        legend_loc : str, optional</span>
<span class="sd">            Location of legend. Default is &#39;best&#39;</span>
<span class="sd">        grid : bool, optional</span>
<span class="sd">            Whether to display grid lines</span>
<span class="sd">        style : dict or list of dict, optional</span>
<span class="sd">            Plotting style(s) to apply to lines. Each dict can contain matplotlib</span>
<span class="sd">            line properties (color, linestyle, marker, alpha, etc.)</span>
<span class="sd">        colors : str or list, optional</span>
<span class="sd">            Color(s) for plots. If a list, cycles through colors</span>
<span class="sd">        linewidth : float, optional</span>
<span class="sd">            Line width for plots</span>
<span class="sd">        label_map : dict, optional</span>
<span class="sd">            Mapping from term names to display labels</span>
<span class="sd">        fig_size : tuple, optional</span>
<span class="sd">            Figure size (width, height) in inches</span>
<span class="sd">        save_path : str, optional</span>
<span class="sd">            Path to save figure. If None, figure is not saved</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            DPI for saved figure</span>
<span class="sd">        xlim : tuple, optional</span>
<span class="sd">            (min, max) for x-axis</span>
<span class="sd">        ylim : tuple, optional</span>
<span class="sd">            (min, max) for y-axis</span>
<span class="sd">        scale_factors : dict or float, optional</span>
<span class="sd">            Scaling factor(s) for plotted quantities</span>
<span class="sd">        return_fig : bool, optional</span>
<span class="sd">            Whether to return the figure object</span>
<span class="sd">        show : bool, optional</span>
<span class="sd">            Whether to show the plot immediately</span>
<span class="sd">        **override_kwargs : dict</span>
<span class="sd">            Additional parameters for FAST-PT function calls</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : matplotlib.figure.Figure, optional</span>
<span class="sd">            Figure object if return_fig is True</span>
<span class="sd">            </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; # Basic plot from terms</span>
<span class="sd">        &gt;&gt;&gt; handler.plot(terms=[&#39;P_1loop&#39;, &#39;P_E&#39;, &#39;P_B&#39;])</span>
<span class="sd">        &gt;&gt;&gt; # Plot with custom styling</span>
<span class="sd">        &gt;&gt;&gt; handler.plot(terms=&#39;P_1loop&#39;, colors=&#39;red&#39;, title=&#39;1-loop SPT&#39;)</span>
<span class="sd">        &gt;&gt;&gt; # Plot with style dictionaries for fine control</span>
<span class="sd">        &gt;&gt;&gt; handler.plot(terms=[&#39;P_1loop&#39;, &#39;P_E&#39;], style=[</span>
<span class="sd">        ...     {&#39;color&#39;: &#39;red&#39;, &#39;linestyle&#39;: &#39;--&#39;, &#39;marker&#39;: &#39;o&#39;, &#39;alpha&#39;: 0.8},</span>
<span class="sd">        ...     {&#39;color&#39;: &#39;blue&#39;, &#39;linestyle&#39;: &#39;-&#39;, &#39;linewidth&#39;: 2}</span>
<span class="sd">        ... ])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cycle</span>
        
        <span class="c1"># Set up figure and axes if not provided</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>
            
        <span class="c1"># Set plot title if provided</span>
        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
            
        <span class="c1"># Set up x-axis values (k)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">k_original</span>
            
        <span class="c1"># Default color cycle</span>
        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span> <span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">,</span> <span class="s1">&#39;#9467bd&#39;</span><span class="p">,</span> 
                      <span class="s1">&#39;#8c564b&#39;</span><span class="p">,</span> <span class="s1">&#39;#e377c2&#39;</span><span class="p">,</span> <span class="s1">&#39;#7f7f7f&#39;</span><span class="p">,</span> <span class="s1">&#39;#bcbd22&#39;</span><span class="p">,</span> <span class="s1">&#39;#17becf&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">colors</span><span class="p">]</span>
        <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
        
        <span class="c1"># Set up label mapping</span>
        <span class="k">if</span> <span class="n">label_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label_map</span> <span class="o">=</span> <span class="p">{}</span>
            
        <span class="c1"># Set up scale factors</span>
        <span class="k">if</span> <span class="n">scale_factors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale_factors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_factors</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">default_scale</span> <span class="o">=</span> <span class="n">scale_factors</span>
            <span class="n">scale_factors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        
        <span class="c1"># Prepare style dictionaries</span>
        <span class="k">if</span> <span class="n">style</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="p">[{}]</span>  <span class="c1"># Empty dict = use defaults</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">style</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">style</span> <span class="o">=</span> <span class="p">[</span><span class="n">style</span><span class="p">]</span>  <span class="c1"># Single style dict</span>
        <span class="n">style_cycle</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
        
        <span class="c1"># Get data to plot</span>
        <span class="n">to_plot</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Case 1: User provided data directly</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">to_plot</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">label_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Component </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">to_plot</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">label_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Data&quot;</span><span class="p">)</span>
                    <span class="n">to_plot</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="k">else</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unsupported data format. Provide a dict, list, tuple, or numpy array.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">terms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Case 2: User provided term names to plot</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">terms</span><span class="p">]</span>
                
            <span class="c1"># Get data for each term</span>
            <span class="n">term_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">terms</span><span class="p">,</span> <span class="o">**</span><span class="n">override_kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">term_name</span> <span class="o">=</span> <span class="n">terms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">display_label</span> <span class="o">=</span> <span class="n">label_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term_name</span><span class="p">,</span> <span class="n">term_name</span><span class="p">)</span>
                <span class="n">to_plot</span><span class="p">[</span><span class="n">display_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">term_name</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                    <span class="n">display_label</span> <span class="o">=</span> <span class="n">label_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term_name</span><span class="p">,</span> <span class="n">term_name</span><span class="p">)</span>
                    <span class="n">to_plot</span><span class="p">[</span><span class="n">display_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">term_data</span><span class="p">[</span><span class="n">term_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either &#39;data&#39; or &#39;terms&#39; must be provided.&quot;</span><span class="p">)</span>
            
        <span class="c1"># Plot each data series</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">data_array</span> <span class="ow">in</span> <span class="n">to_plot</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Get current style and color</span>
            <span class="n">curr_style</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">style_cycle</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Copy to avoid modifying the original</span>
            
            <span class="c1"># Add default color if not in style</span>
            <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_style</span><span class="p">:</span>
                <span class="n">curr_style</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">color_cycle</span><span class="p">)</span>
                
            <span class="c1"># Set default linewidth if not in style</span>
            <span class="k">if</span> <span class="s1">&#39;linewidth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">curr_style</span><span class="p">:</span>
                <span class="n">curr_style</span><span class="p">[</span><span class="s1">&#39;linewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">linewidth</span>
                
            <span class="c1"># Apply scale factor if provided for this label</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">scale_factors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">default_scale</span><span class="p">)</span>
            
            <span class="c1"># Chek_h if data contains negative values</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">data_array</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># Plot positive values</span>
                <span class="n">mask_pos</span> <span class="o">=</span> <span class="n">data_array</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_pos</span><span class="p">):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">mask_pos</span><span class="p">],</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">data_array</span><span class="p">[</span><span class="n">mask_pos</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">curr_style</span><span class="p">)</span>
                
                <span class="c1"># Plot negative values with dashed lines for visibility</span>
                <span class="n">mask_neg</span> <span class="o">=</span> <span class="n">data_array</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask_neg</span><span class="p">):</span>
                    <span class="n">neg_style</span> <span class="o">=</span> <span class="n">curr_style</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">neg_style</span><span class="p">[</span><span class="s1">&#39;linestyle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">neg_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;linestyle&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># Default to dashed</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">mask_neg</span><span class="p">],</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">data_array</span><span class="p">[</span><span class="n">mask_neg</span><span class="p">]),</span> <span class="o">**</span><span class="n">neg_style</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Regular plotting for non-negative data</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">data_array</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">curr_style</span><span class="p">)</span>
                
        <span class="c1"># Set scales</span>
        <span class="k">if</span> <span class="n">log_scale</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">log_scale</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">x_log</span><span class="p">,</span> <span class="n">y_log</span> <span class="o">=</span> <span class="n">log_scale</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_log</span> <span class="o">=</span> <span class="n">y_log</span> <span class="o">=</span> <span class="kc">True</span>
                
            <span class="k">if</span> <span class="n">x_log</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y_log</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
        <span class="c1"># Set axis labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$k$ [$h$ Mpc$^{-1}$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$P(k)$ [$h^{-3}$ Mpc$^3$]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        
        <span class="c1"># Set limits if provided</span>
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            
        <span class="c1"># Add grid if requested</span>
        <span class="k">if</span> <span class="n">grid</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            
        <span class="c1"># Add legend if there are labeled lines</span>
        <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legend_loc</span><span class="p">)</span>
            
        <span class="c1"># Apply tight layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            
        <span class="c1"># Save figure if path provided</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Show the plot if requested</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            
        <span class="c1"># Return figure if requested</span>
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span></div>

            
<div class="viewcode-block" id="FPTHandler.plot_comparison">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.plot_comparison">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_dict</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ratio_baseline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create comparison plots for multiple results, optionally with ratio panel.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        results_dict : dict</span>
<span class="sd">            Dictionary mapping labels to data arrays</span>
<span class="sd">        k : array-like, optional</span>
<span class="sd">            k values for x-axis. If None, uses handler&#39;s FASTPT k values</span>
<span class="sd">        ratio : bool, optional</span>
<span class="sd">            Whether to include a ratio panel</span>
<span class="sd">        ratio_baseline : str, optional</span>
<span class="sd">            Key in results_dict to use as baseline for ratio.</span>
<span class="sd">            If None, uses the first key in results_dict</span>
<span class="sd">        fig_size : tuple, optional</span>
<span class="sd">            Figure size (width, height) in inches</span>
<span class="sd">        **plot_kwargs : dict</span>
<span class="sd">            Additional keyword arguments passed to the plot method</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : matplotlib.figure.Figure</span>
<span class="sd">            The created figure</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; handler = FPTHandler(fpt, P=P_linear, C_window=0.75)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop_result = handler.run(&#39;one_loop_dd&#39;)</span>
<span class="sd">        &gt;&gt;&gt; ia_result = handler.run(&#39;IA_tt&#39;)</span>
<span class="sd">        &gt;&gt;&gt; handler.plot_comparison({&#39;1-loop&#39;: P_1loop_result, &#39;IA&#39;: ia_result})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">k_original</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;results_dict cannot be empty&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ratio_baseline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use first key as baseline if not specified</span>
            <span class="n">ratio_baseline</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">ratio</span> <span class="ow">and</span> <span class="n">ratio_baseline</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ratio baseline &#39;</span><span class="si">{</span><span class="n">ratio_baseline</span><span class="si">}</span><span class="s2">&#39; not found in results&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create figure and axes</span>
        <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">fig_size</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Plot main data</span>
        <span class="c1"># Remove parameters we&#39;re handling explicitly to avoid conflicts</span>
        <span class="n">plot_kwargs_filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="s1">&#39;save_path&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;ax&#39;</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">results_dict</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs_filtered</span><span class="p">)</span>
    
        <span class="c1"># Plot ratio panel if requested</span>
        <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
            <span class="n">baseline_data</span> <span class="o">=</span> <span class="n">results_dict</span><span class="p">[</span><span class="n">ratio_baseline</span><span class="p">]</span>
            <span class="n">ratio_data</span> <span class="o">=</span> <span class="p">{}</span>
        
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">baseline_data</span><span class="p">):</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Calculate ratio, handling potential zeros or NaNs</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
                    <span class="n">ratio_array</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">baseline_data</span>
                    <span class="c1"># Replace inf/NaN with zeros for plotting</span>
                    <span class="n">ratio_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ratio_array</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="n">ratio_data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ratio_baseline</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ratio_array</span>
            
            <span class="c1"># Plot the ratios</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ratio_data</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">log_scale</span><span class="o">=</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> 
                    <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
            <span class="c1"># Add horizontal line at y=1.0</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        
            <span class="c1"># Set y-label for ratio panel</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Ratio&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        
            <span class="c1"># Remove x-label from top plot to avoid overlap</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="c1"># Only show x tik_h labels on bottom panel</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xtik_hlabels</span><span class="p">(),</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># Save figure if path provided</span>
        <span class="k">if</span> <span class="s1">&#39;save_path&#39;</span> <span class="ow">in</span> <span class="n">plot_kwargs</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plot_kwargs</span><span class="p">[</span><span class="s1">&#39;save_path&#39;</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="n">plot_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dpi&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to: </span><span class="si">{</span><span class="n">plot_kwargs</span><span class="p">[</span><span class="s1">&#39;save_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Show plot</span>
        <span class="k">if</span> <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="n">fig</span></div>

    
<div class="viewcode-block" id="FPTHandler.generate_power_spectra">
<a class="viewcode-back" href="../../api.html#fastpt.FPTHandler.generate_power_spectra">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_power_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;classy&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate power spectra using the specified method.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            Either &#39;classy&#39; or &#39;camb&#39;</span>
<span class="sd">        mode : str</span>
<span class="sd">            &#39;single&#39;, &#39;bulk&#39;, or &#39;diff&#39;</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Cosmological parameters to pass to the appropriate method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;classy&#39;</span><span class="p">,</span> <span class="s1">&#39;camb&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid method. Choose either &#39;classy&#39; or &#39;camb&#39;.&quot;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;bulk&#39;</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode. Choose &#39;single&#39;, &#39;bulk&#39;, or &#39;diff&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_diff_power_spectra</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;bulk&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bulk_power_spectra</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; must be a single value for single mode.&quot;</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;classy&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_power_spectra</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camb_power_spectra</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_bulk_power_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        
        <span class="n">param_arrays</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_len</span><span class="p">:</span>
                    <span class="n">param_arrays</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_arrays</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_arrays</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;classy&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_len</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_class_power_spectra</span><span class="p">(</span>
                    <span class="n">omega_b</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;omega_b&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">omega_cdm</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">h</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">))</span>
            
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">output</span>
            
        <span class="k">elif</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;camb&#39;</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_len</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_camb_power_spectra</span><span class="p">(</span>
                    <span class="n">omega_b</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;omega_b&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">omega_cdm</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">h</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">z</span><span class="o">=</span><span class="n">param_arrays</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1">#Update to include new params for CAMB</span>
                <span class="p">))</span>
            
            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid method. Choose either &#39;classy&#39; or &#39;camb&#39;.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_diff_power_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;classy&#39;</span><span class="p">,</span> <span class="s1">&#39;camb&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid method. Choose either &#39;classy&#39; or &#39;camb&#39;.&quot;</span><span class="p">)</span>
        
        <span class="n">diff_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;omega_cdm&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.12</span><span class="p">]),</span>
            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.67</span><span class="p">]),</span>
            <span class="s1">&#39;omega_b&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;omega_b&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.022</span><span class="p">]),</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]),</span>
        <span class="p">}</span>
        
        <span class="n">has_param_with_length_3</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">diff_params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_param_with_length_3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one parameter must have length 3 to use diff mode.&quot;</span><span class="p">)</span>
        
        <span class="n">camb_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;As&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="mf">2.1e-9</span><span class="p">),</span>
            <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">),</span>
            <span class="s1">&#39;k_hunit&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;k_hunit&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;nonlinear&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nonlinear&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;H0&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;H0&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;kmax&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kmax&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;hubble_units&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hubble_units&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;extrap_kmax&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extrap_kmax&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;k_per_logint&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;k_per_logint&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;halofit_version&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;halofit_version&#39;</span><span class="p">,</span> <span class="s1">&#39;mead&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">diff_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                <span class="n">diff_params</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="k">else</span> <span class="n">value</span>
                <span class="k">continue</span>
                
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; must be a list or numpy array.&quot;</span><span class="p">)</span>                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; must have length 1 or 3.&quot;</span><span class="p">)</span>                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">diff_params</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">3</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">compute_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_power_spectra</span> <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;classy&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camb_power_spectra</span>
        
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">diff_params</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span>
            <span class="n">param_combinations</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">center_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">diff_params</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_b&#39;</span><span class="p">]]</span>
            <span class="n">param_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_values</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">param_idx</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;omega_cdm&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_b&#39;</span><span class="p">]):</span>
                <span class="n">param_values</span> <span class="o">=</span> <span class="n">diff_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">param_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">param_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">param_values</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="k">continue</span>
                    
                <span class="k">for</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">center_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">param_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_values</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
                    <span class="n">param_combinations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="n">param_combinations</span><span class="p">:</span>
                <span class="n">omega_cdm</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">omega_b</span> <span class="o">=</span> <span class="n">combo</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega_cdm</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">omega_b</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;classy&#39;</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_func</span><span class="p">(</span>
                        <span class="n">omega_cdm</span><span class="o">=</span><span class="n">omega_cdm</span><span class="p">,</span>
                        <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                        <span class="n">omega_b</span><span class="o">=</span><span class="n">omega_b</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">z</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_func</span><span class="p">(</span>
                        <span class="n">omega_cdm</span><span class="o">=</span><span class="n">omega_cdm</span><span class="p">,</span>
                        <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                        <span class="n">omega_b</span><span class="o">=</span><span class="n">omega_b</span><span class="p">,</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">camb_params</span>
                    <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_class_power_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">omega_cdm</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">omega_b</span><span class="o">=</span><span class="mf">0.022</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">classy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Class</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Classy is not installed. Please install it to use this function.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">k_original</span>
        <span class="n">k_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="s1">&#39;mPk&#39;</span><span class="p">,</span>
            <span class="s1">&#39;P_k_max_1/Mpc&#39;</span><span class="p">:</span> <span class="n">k_max</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span>
            <span class="s1">&#39;z_max_pk&#39;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
            <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span>
            <span class="s1">&#39;omega_b&#39;</span><span class="p">:</span> <span class="n">omega_b</span><span class="p">,</span>
            <span class="s1">&#39;omega_cdm&#39;</span><span class="p">:</span> <span class="n">omega_cdm</span>
        <span class="p">}</span>
        <span class="n">cosmo</span> <span class="o">=</span> <span class="n">Class</span><span class="p">()</span>
        <span class="n">cosmo</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">cosmo</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cosmo</span><span class="o">.</span><span class="n">pk</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k</span><span class="p">])</span>
        <span class="n">cosmo</span><span class="o">.</span><span class="n">struct_cleanup</span><span class="p">()</span>
        <span class="n">cosmo</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_camb_power_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="n">nonlinear</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">h</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.67</span><span class="p">,</span>
                                <span class="n">H0</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">omega_b</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.022</span><span class="p">,</span>
                                <span class="n">omega_cdm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.122</span><span class="p">,</span>
                                <span class="n">As</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.1e-9</span><span class="p">,</span>
                                <span class="n">ns</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.965</span><span class="p">,</span>
                                <span class="n">halofit_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mead&#39;</span><span class="p">,</span>
                                <span class="n">kmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">hubble_units</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">k_hunit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">extrap_kmax</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">k_per_logint</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
                               <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">camb</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;CAMB is not installed. Please install it to use this function.&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastpt</span><span class="o">.</span><span class="n">k_original</span>

        <span class="k">if</span> <span class="n">H0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">H0</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="mi">100</span>
         <span class="c1"># 1) Set up CAMB parameters</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">CAMBparams</span><span class="p">()</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_cosmology</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="n">H0</span><span class="p">,</span> <span class="n">ombh2</span><span class="o">=</span><span class="n">omega_b</span><span class="p">,</span> <span class="n">omch2</span><span class="o">=</span><span class="n">omega_cdm</span><span class="p">)</span>                 <span class="c1"># standard cosmology</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">InitPower</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">As</span><span class="o">=</span><span class="n">As</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>                            <span class="c1"># primordial spectrum</span>

        <span class="c1"># 2) Matter power settings</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">kmax</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">set_matter_power</span><span class="p">(</span><span class="n">redshifts</span><span class="o">=</span><span class="p">[</span><span class="n">z</span><span class="p">],</span> <span class="n">kmax</span><span class="o">=</span><span class="n">kmax</span><span class="p">,</span> <span class="n">k_per_logint</span><span class="o">=</span><span class="n">k_per_logint</span><span class="p">)</span>

        <span class="c1"># 3) Choose HALOFIT version (no &#39;nonlinear&#39; flag here)</span>
        <span class="n">pars</span><span class="o">.</span><span class="n">NonLinearModel</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">halofit_version</span><span class="o">=</span><span class="n">halofit_version</span><span class="p">)</span>

        <span class="c1"># 4) Build interpolator, passing the nonlinear flag here</span>
        <span class="n">PK</span> <span class="o">=</span> <span class="n">camb</span><span class="o">.</span><span class="n">get_matter_power_interpolator</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span>
                                                <span class="n">zmin</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">nz_step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zs</span><span class="o">=</span><span class="p">[</span><span class="n">z</span><span class="p">],</span>
                                                <span class="n">kmax</span><span class="o">=</span><span class="n">kmax</span><span class="p">,</span>
                                                <span class="n">nonlinear</span><span class="o">=</span><span class="n">nonlinear</span><span class="p">,</span>
                                                <span class="n">hubble_units</span><span class="o">=</span><span class="n">hubble_units</span><span class="p">,</span>
                                                <span class="n">k_hunit</span><span class="o">=</span><span class="n">k_hunit</span><span class="p">,</span>
                                                <span class="n">extrap_kmax</span><span class="o">=</span><span class="n">extrap_kmax</span><span class="p">,</span>
                                                <span class="n">k_per_logint</span><span class="o">=</span><span class="n">k_per_logint</span><span class="p">)</span>

        <span class="c1"># 5) Evaluate at stored k</span>
        <span class="k">return</span> <span class="n">PK</span><span class="o">.</span><span class="n">P</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span></div>

    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2025, FAST-PT developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>