

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fastpt.FASTPT &mdash; FAST-PT 3.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=828ea960"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            FAST-PT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../theory.html">Theory</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FAST-PT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fastpt.FASTPT</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fastpt.FASTPT</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	FASTPT is a numerical algorithm to calculate</span>
<span class="sd">	1-loop contributions to the matter power spectrum</span>
<span class="sd">	and other integrals of a similar type.</span>
<span class="sd">	The method is presented in papers arXiv:1603.04826 and arXiv:1609.05978</span>
<span class="sd">	Please cite these papers if you are using FASTPT in your research.</span>

<span class="sd">	Joseph E. McEwen (c) 2016</span>
<span class="sd">	mcewen.24@osu.edu</span>

<span class="sd">	Xiao Fang</span>
<span class="sd">	fang.307@osu.edu</span>

<span class="sd">	Jonathan A. Blazek</span>
<span class="sd">	blazek.35@osu.edu</span>


<span class="sd">	FFFFFFFF    A           SSSSSSSSS   TTTTTTTTTTTTTT             PPPPPPPPP    TTTTTTTTTTTT</span>
<span class="sd">	FF     	   A A         SS                 TT                   PP      PP        TT</span>
<span class="sd">	FF        A   A        SS                 TT                   PP      PP        TT</span>
<span class="sd">	FFFFF    AAAAAAA        SSSSSSSS          TT       ==========  PPPPPPPPP         TT</span>
<span class="sd">	FF      AA     AA              SS         TT                   PP                TT</span>
<span class="sd">	FF     AA       AA             SS         TT                   PP                TT</span>
<span class="sd">	FF    AA         AA    SSSSSSSSS          TT                   PP                TT</span>


<span class="sd">	The FASTPT class is the workhorse of the FASTPT algorithm.</span>
<span class="sd">	This class calculates integrals of the form:</span>

<span class="sd">	\int \frac{d^3q}{(2 \pi)^3} K(q,k-q) P(q) P(|k-q|)</span>

<span class="sd">	\int \frac{d^3q_1}{(2 \pi)^3} K(\hat{q_1} \dot \hat{q_2},\hat{q_1} \dot \hat{k}, \hat{q_2} \dot \hat{k}, q_1, q_2) P(q_1) P(|k-q_1|)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.info</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">pi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.fastpt_extr</span><span class="w"> </span><span class="kn">import</span> <span class="n">p_window</span><span class="p">,</span> <span class="n">c_window</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.matter_power_spt</span><span class="w"> </span><span class="kn">import</span> <span class="n">P_13_reg</span><span class="p">,</span> <span class="n">Y1_reg_NL</span><span class="p">,</span> <span class="n">Y2_reg_NL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.initialize_params</span><span class="w"> </span><span class="kn">import</span> <span class="n">scalar_stuff</span><span class="p">,</span> <span class="n">tensor_stuff</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_tt</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_tt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_ABD</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_A</span><span class="p">,</span> <span class="n">IA_DEE</span><span class="p">,</span> <span class="n">IA_DBB</span><span class="p">,</span> <span class="n">P_IA_B</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_ta</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_deltaE1</span><span class="p">,</span> <span class="n">P_IA_deltaE2</span><span class="p">,</span> <span class="n">IA_0E0E</span><span class="p">,</span> <span class="n">IA_0B0B</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_gb2</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_gb2_F2</span><span class="p">,</span> <span class="n">IA_gb2_fe</span><span class="p">,</span> <span class="n">IA_gb2_he</span><span class="p">,</span> <span class="n">P_IA_13S2F2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_gb2</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_gb2_S2F2</span><span class="p">,</span> <span class="n">IA_gb2_S2fe</span><span class="p">,</span> <span class="n">IA_gb2_S2he</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_ct</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_tij_feG2</span><span class="p">,</span> <span class="n">IA_tij_heG2</span><span class="p">,</span> <span class="n">IA_tij_F2F2</span><span class="p">,</span> <span class="n">IA_tij_G2G2</span><span class="p">,</span> <span class="n">IA_tij_F2G2</span><span class="p">,</span> <span class="n">P_IA_13G</span><span class="p">,</span> <span class="n">P_IA_13F</span><span class="p">,</span> <span class="n">IA_tij_F2G2reg</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.IA_ctbias</span><span class="w"> </span><span class="kn">import</span> <span class="n">IA_gb2_F2</span><span class="p">,</span> <span class="n">IA_gb2_G2</span><span class="p">,</span> <span class="n">IA_gb2_S2F2</span><span class="p">,</span> <span class="n">IA_gb2_S2G2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.OV</span><span class="w"> </span><span class="kn">import</span> <span class="n">OV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.kPol</span><span class="w"> </span><span class="kn">import</span> <span class="n">kPol</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.RSD</span><span class="w"> </span><span class="kn">import</span> <span class="n">RSDA</span><span class="p">,</span> <span class="n">RSDB</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">RSD_ItypeII</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.P_extend</span><span class="w"> </span><span class="kn">import</span> <span class="n">k_extend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">FASTPT_simple</span> <span class="k">as</span> <span class="n">fastpt_simple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.CacheManager</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">fftconvolve</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.fft</span><span class="w"> </span><span class="kn">import</span> <span class="n">ifft</span><span class="p">,</span> <span class="n">irfft</span><span class="p">,</span> <span class="n">rfft</span>

<span class="n">log2</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">time</span>
<span class="k">def</span><span class="w"> </span><span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to time function execution&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(New) Function </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> executed in </span><span class="si">{</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cached_property</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to cache property values&quot;&quot;&quot;</span>
    <span class="n">cache_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">getter</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">,</span> <span class="n">method</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">cache_name</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">)</span>

<div class="viewcode-block" id="FASTPT">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FASTPT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FASTPT is a numerical algorithm to calculate</span>
<span class="sd">	1-loop contributions to the matter power spectrum</span>
<span class="sd">	and other integrals of a similar type.</span>
<span class="sd">	The method is presented in papers arXiv:1603.04826 and arXiv:1609.05978</span>
<span class="sd">	Please cite these papers if you are using FASTPT in your research.</span>

<span class="sd">    Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : array_like</span>
<span class="sd">            The input k-grid (wavenumbers) in 1/Mpc. Must be logarithmically spaced</span>
<span class="sd">            with equal spacing in log(k) and contain an even number of elements.</span>
<span class="sd">        </span>
<span class="sd">        nu : float, optional</span>
<span class="sd">            Deprecated. Previously used for scaling relations, no longer required.</span>
<span class="sd">        </span>
<span class="sd">        to_do : list of str, optional</span>
<span class="sd">            List of calculations to prepare matrices for. Terms will be calculated as needed</span>
<span class="sd">            even without specifying them here, but pre-computing matrices can save time on the </span>
<span class="sd">            initial run of any function. &#39;All&#39; or &#39;everything&#39; will initialize all terms.</span>
<span class="sd">        </span>
<span class="sd">        param_mat : array_like, optional</span>
<span class="sd">            Custom parameter matrix for extensions (advanced usage).</span>
<span class="sd">        </span>
<span class="sd">        low_extrap : float, optional</span>
<span class="sd">            If provided, extrapolate the power spectrum to lower k values </span>
<span class="sd">            down to 10^(low_extrap). Helps with edge effects. Typical value: -5.</span>
<span class="sd">        </span>
<span class="sd">        high_extrap : float, optional</span>
<span class="sd">            If provided, extrapolate the power spectrum to higher k values </span>
<span class="sd">            up to 10^(high_extrap). Helps with edge effects. Typical value: 3.</span>
<span class="sd">            Must be greater than low_extrap if both are provided.</span>
<span class="sd">        </span>
<span class="sd">        n_pad : int, optional</span>
<span class="sd">            Number of zeros to pad the array with on both ends. </span>
<span class="sd">            Helps reduce edge effects in FFT calculations. If None, defaults to</span>
<span class="sd">            half the length of the input k array.</span>
<span class="sd">            </span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints additional information during calculations.</span>
<span class="sd">        </span>
<span class="sd">        simple : bool, optional</span>
<span class="sd">            If True, uses the older, simplified FASTPT interface. Will be deprecated.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The input k array must be strictly increasing, logarithmically spaced with consistent spacing,</span>
<span class="sd">        contain an even number of elements</span>
<span class="sd">        </span>
<span class="sd">        Using extrapolation (low_extrap/high_extrap) and padding (n_pad) is </span>
<span class="sd">        recommended to reduce numerical artifacts from the FFT-based algorithm.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Basic initialization for 1-loop calculations:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; from fastpt import FASTPT</span>
<span class="sd">        &gt;&gt;&gt; k = np.logspace(-3, 1, 200)</span>
<span class="sd">        &gt;&gt;&gt; P_linear = k**(-1.5) * 1000  # Example power spectrum</span>
<span class="sd">        &gt;&gt;&gt; fpt = FASTPT(k, low_extrap=-5, high_extrap=3, n_pad=100)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop = fpt.one_loop_dd(P_linear)[0]</span>
<span class="sd">        </span>
<span class="sd">        With multiple components:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; fpt = FASTPT(k, to_do=[&#39;one_loop_dd&#39;, &#39;IA_tt&#39;, &#39;RSD&#39;], </span>
<span class="sd">        ...              low_extrap=-5, high_extrap=3, n_pad=100)</span>
<span class="sd">        &gt;&gt;&gt; P_1loop = fpt.one_loop_dd(P_linear)[0]</span>
<span class="sd">        &gt;&gt;&gt; P_IA_E, P_IA_B = fpt.IA_tt(P_linear)</span>
<span class="sd">        &gt;&gt;&gt; A1, A3, A5, B0, B2, B4, B6, P_Ap1, P_Ap3, P_Ap5 = fpt.RSD_components(P_linear, f=0.55)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FASTPT.__init__">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">to_do</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param_mat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">low_extrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">high_extrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_pad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">simple</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must provide an input k array.&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: nu is no longer needed for FAST-PT initialization.&quot;</span><span class="p">)</span>
        

        <span class="c1"># if no to_do list is given, default to fastpt_simple SPT case</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">simple</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Note: You are using an earlier call structure for FASTPT. Your code will still run correctly, calling FASTPT_simple. See user manual.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>  <span class="c1"># give a warning if nu=None that a default value is being used.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: No value for nu is given. FASTPT_simple is being called with a default of nu=-2&#39;</span><span class="p">)</span>
                <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>  <span class="c1"># this is the default value for P22+P13 and bias calculation</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: No to_do list is given therefore calling FASTPT_simple. FASTPT_simple will soon be DEPRECATED.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt_simple</span> <span class="o">=</span> <span class="n">fastpt_simple</span><span class="o">.</span><span class="n">FASTPT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">param_mat</span><span class="o">=</span><span class="n">param_mat</span><span class="p">,</span> <span class="n">low_extrap</span><span class="o">=</span><span class="n">low_extrap</span><span class="p">,</span>
                                                  <span class="n">high_extrap</span><span class="o">=</span><span class="n">high_extrap</span><span class="p">,</span> <span class="n">n_pad</span><span class="o">=</span><span class="n">n_pad</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Exit initialization here, since fastpt_simple performs the various checks on the k grid and does extrapolation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">CacheManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#Stores the names of X terms to be used as an efficient unique identifier in hash keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__k_original</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extrap</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">low_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">high_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">high_extrap</span> <span class="o">&lt;</span> <span class="n">low_extrap</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;high_extrap must be greater than low_extrap&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EK</span> <span class="o">=</span> <span class="n">k_extend</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">low_extrap</span><span class="p">,</span> <span class="n">high_extrap</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">extrap_k</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extrap</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">low_extrap</span> <span class="o">=</span> <span class="n">low_extrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">high_extrap</span> <span class="o">=</span> <span class="n">high_extrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__k_extrap</span> <span class="o">=</span> <span class="n">k</span> <span class="c1">#K extrapolation not padded</span>

        
        <span class="c1"># check for log spacing</span>
        <span class="c1"># print(&#39;Initializing k-grid quantities...&#39;)</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="c1"># dk_test=np.ones_like(dk)*dk[0]</span>
        <span class="n">delta_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dk_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_L</span>

        <span class="n">log_sample_test</span> <span class="o">=</span> <span class="s1">&#39;ERROR! FASTPT will not work if your in put (k,Pk) values are not sampled evenly in log space!&#39;</span>
        <span class="n">np</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_array_almost_equal</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">dk_test</span><span class="p">,</span> <span class="n">decimal</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">err_msg</span><span class="o">=</span><span class="n">log_sample_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the minumum and maximum inputed log10(k) are: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the grid spacing Delta log (k) is, </span><span class="si">{</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;number of input k points are, </span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the power spectrum is extraplated to log10(k_min)=</span><span class="si">{</span><span class="n">low_extrap</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the power spectrum is extraplated to log10(k_max)=</span><span class="si">{</span><span class="n">high_extrap</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the power spectrum has </span><span class="si">{</span><span class="n">n_pad</span><span class="si">}</span><span class="s1"> zeros added to both ends of the power spectrum&#39;</span><span class="p">)</span>


        <span class="c1"># print(self.k_extrap.size, &#39;k size&#39;)</span>
        <span class="c1"># size of input array must be an even number</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input array must contain an even number of elements.&#39;</span><span class="p">)</span>
        <span class="c1"># can we just force the extrapolation to add an element if we need one more? how do we prevent the extrapolation from giving us an odd number of elements? is that hard coded into extrap? or just trim the lowest k value if there is an odd numebr and no extrapolation is requested.</span>

        <span class="k">if</span> <span class="n">n_pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: N_pad is recommended but none has been provided, defaulting to 0.5*len(k) = </span><span class="si">{</span><span class="n">n_pad</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">=</span> <span class="n">n_pad</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Make sure n_pad is an integer</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_pad</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">n_pad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_pad</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">=</span> <span class="n">n_pad</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">n_pad</span>
            <span class="n">d_logk</span> <span class="o">=</span> <span class="n">delta_L</span>
            <span class="n">k_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_logk</span>
            <span class="n">k_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k_pad</span><span class="p">)</span>
            <span class="n">k_left</span> <span class="o">=</span> <span class="n">k_pad</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">k_pad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_pad</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">d_logk</span>
            <span class="n">k_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k_pad</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">k_left</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">k_right</span><span class="p">))</span>
            <span class="n">n_pad_check</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">delta_L</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">n_pad</span> <span class="o">&lt;</span> <span class="n">n_pad_check</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*** Warning ***&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You should consider increasing your zero padding to at least </span><span class="si">{</span><span class="n">n_pad_check</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to ensure that the minimum k_output is &gt; 2k_min in the FASTPT universe.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;k_min in the FASTPT universe is </span><span class="si">{</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> while k_min_input is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__k_final</span> <span class="o">=</span> <span class="n">k</span> <span class="c1">#log spaced k, with padding and extrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_size</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># self.scalar_nu=-2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># define eta_m and eta_n=eta_m</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta_L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

        <span class="c1"># define l and tau_l</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n_l</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_l</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;one_loop_dd&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;one_loop_cleft_dd&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s1">&#39;dd_bias&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;IA_all&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;IA_tt&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;IA_ta&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s1">&#39;IA_mix&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;OV&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;kPol&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;RSD&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;IRres&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s1">&#39;tij&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;gb2&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> 
            <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;everything&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">to_do</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: to_do list is no longer needed for FAST-PT initialization. Terms will now be calculated as needed.&quot;</span><span class="p">)</span>
        
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">to_do</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">entry</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;everything&#39;</span><span class="p">}:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;IA_all&#39;</span><span class="p">,</span> <span class="s1">&#39;IA&#39;</span><span class="p">}:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IA_tt&#39;</span><span class="p">,</span> <span class="s1">&#39;IA_ta&#39;</span><span class="p">,</span> <span class="s1">&#39;IA_mix&#39;</span><span class="p">,</span> <span class="s1">&#39;gb2&#39;</span><span class="p">,</span> <span class="s1">&#39;tij&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="s1">&#39;dd_bias&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;one_loop_dd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;dd_bias&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">entry</span> <span class="o">==</span> <span class="s1">&#39;tij&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gb2&#39;</span><span class="p">,</span> <span class="s1">&#39;one_loop_dd&#39;</span><span class="p">,</span> <span class="s1">&#39;tij&#39;</span><span class="p">,</span> <span class="s1">&#39;IA_tt&#39;</span><span class="p">,</span> <span class="s1">&#39;IA_ta&#39;</span><span class="p">,</span> <span class="s1">&#39;IA_mix&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;FAST-PT does not recognize </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s1"> in the to_do list.</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s1"> are the valid entries.&#39;</span><span class="p">)</span>

        
        <span class="c1">### INITIALIZATION of k-grid quantities ###</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;one_loop_dd&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;dd_bias&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;IRres&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_sptG</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;one_loop_cleft_dd&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_cleft</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;IA_tt&#39;</span><span class="p">]:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_E</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_B</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;IA_mix&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_A</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_DEE</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_DBB</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;IA_ta&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_deltaE1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_0E0E</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_0B0B</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;gb2&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_fe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_he</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;tij&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_feG2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_heG2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_F2F2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_G2G2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_F2G2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_F2G2reg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_F2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_G2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2F2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2fe</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2he</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2G2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;OV&#39;</span><span class="p">]:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X_OV</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;kPol&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_kP1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_kP2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_kP3</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">todo_dict</span><span class="p">[</span><span class="s1">&#39;RSD&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_RSDA</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_RSDB</span></div>

        
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">k_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__k_original</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">k_extrap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__k_extrap</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">k_final</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__k_final</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_spt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scalar_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_spt&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_lpt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scalar_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_lpt&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_sptG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scalar_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_sptG&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_cleft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">scalar_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_cleft&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_E</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hE_tab</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">IA_tt</span><span class="p">()</span>
        <span class="n">p_mat_E</span> <span class="o">=</span> <span class="n">hE_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_E</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_E&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_B</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">hB_tab</span> <span class="o">=</span> <span class="n">IA_tt</span><span class="p">()</span>
        <span class="n">p_mat_B</span> <span class="o">=</span> <span class="n">hB_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_B&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_A</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_A_tab</span> <span class="o">=</span> <span class="n">IA_A</span><span class="p">()</span>
        <span class="n">p_mat_A</span> <span class="o">=</span> <span class="n">IA_A_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_A&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_DEE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_DEE_tab</span> <span class="o">=</span> <span class="n">IA_DEE</span><span class="p">()</span>
        <span class="n">p_mat_DEE</span> <span class="o">=</span> <span class="n">IA_DEE_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_DEE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_DEE&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_DBB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_DBB_tab</span> <span class="o">=</span> <span class="n">IA_DBB</span><span class="p">()</span>
        <span class="n">p_mat_DBB</span> <span class="o">=</span> <span class="n">IA_DBB_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_DBB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_DBB&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_deltaE1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_deltaE1_tab</span> <span class="o">=</span> <span class="n">IA_deltaE1</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">IA_deltaE1_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_deltaE1&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_0E0E</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_0E0E_tab</span> <span class="o">=</span> <span class="n">IA_0E0E</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">IA_0E0E_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_0E0E&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_0B0B</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_0B0B_tab</span> <span class="o">=</span> <span class="n">IA_0B0B</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">IA_0B0B_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_0B0B&#39;</span>  
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_fe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_fe_tab</span> <span class="o">=</span> <span class="n">IA_gb2_fe</span><span class="p">()</span>
        <span class="n">p_mat_gb2_fe</span> <span class="o">=</span> <span class="n">IA_gb2_fe_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_fe&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_he</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_he_tab</span> <span class="o">=</span> <span class="n">IA_gb2_he</span><span class="p">()</span>
        <span class="n">p_mat_gb2_he</span> <span class="o">=</span> <span class="n">IA_gb2_he_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_he</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_he&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_feG2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_feG2_tab</span> <span class="o">=</span> <span class="n">IA_tij_feG2</span><span class="p">()</span>
        <span class="n">p_mat_tij_feG2</span> <span class="o">=</span> <span class="n">IA_tij_feG2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_feG2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_feG2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_heG2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_heG2_tab</span> <span class="o">=</span> <span class="n">IA_tij_heG2</span><span class="p">()</span>
        <span class="n">p_mat_tij_heG2</span> <span class="o">=</span> <span class="n">IA_tij_heG2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_heG2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_heG2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_F2F2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_F2F2_tab</span> <span class="o">=</span> <span class="n">IA_tij_F2F2</span><span class="p">()</span>
        <span class="n">p_mat_tij_F2F2</span> <span class="o">=</span> <span class="n">IA_tij_F2F2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_F2F2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_F2F2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_G2G2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_G2G2_tab</span> <span class="o">=</span> <span class="n">IA_tij_G2G2</span><span class="p">()</span>
        <span class="n">p_mat_tij_G2G2</span> <span class="o">=</span> <span class="n">IA_tij_G2G2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_G2G2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_G2G2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_F2G2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_F2G2_tab</span> <span class="o">=</span> <span class="n">IA_tij_F2G2</span><span class="p">()</span>
        <span class="n">p_mat_tij_F2G2</span> <span class="o">=</span> <span class="n">IA_tij_F2G2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_F2G2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_F2G2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_tij_F2G2reg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_tij_F2G2reg_tab</span> <span class="o">=</span><span class="n">IA_tij_F2G2reg</span><span class="p">()</span>
        <span class="n">p_mat_tij_F2G2reg_tab</span> <span class="o">=</span> <span class="n">IA_tij_F2G2reg_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_tij_F2G2reg_tab</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_tij_F2G2reg&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_F2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_F2_tab</span> <span class="o">=</span> <span class="n">IA_gb2_F2</span><span class="p">()</span>
        <span class="n">p_mat_gb2_F2</span> <span class="o">=</span> <span class="n">IA_gb2_F2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_F2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_F2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_G2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_G2_tab</span> <span class="o">=</span> <span class="n">IA_gb2_G2</span><span class="p">()</span>
        <span class="n">p_mat_gb2_G2</span> <span class="o">=</span> <span class="n">IA_gb2_G2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_G2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_G2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_S2F2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_S2F2_tab</span> <span class="o">=</span> <span class="n">IA_gb2_S2F2</span><span class="p">()</span>
        <span class="n">p_mat_gb2_S2F2</span> <span class="o">=</span> <span class="n">IA_gb2_S2F2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_S2F2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_S2F2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_S2fe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_S2fe_tab</span> <span class="o">=</span> <span class="n">IA_gb2_S2fe</span><span class="p">()</span>
        <span class="n">p_mat_gb2_S2fe</span> <span class="o">=</span> <span class="n">IA_gb2_S2fe_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_S2fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_S2fe&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_S2he</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_S2he_tab</span> <span class="o">=</span> <span class="n">IA_gb2_S2he</span><span class="p">()</span>
        <span class="n">p_mat_gb2_S2he</span> <span class="o">=</span> <span class="n">IA_gb2_S2he_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_S2he</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_S2he&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_IA_gb2_S2G2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">IA_gb2_S2G2_tab</span> <span class="o">=</span> <span class="n">IA_gb2_S2G2</span><span class="p">()</span>
        <span class="n">p_mat_gb2_S2G2</span> <span class="o">=</span> <span class="n">IA_gb2_S2G2_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat_gb2_S2G2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_IA_gb2_S2G2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_OV</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">OV_tab</span> <span class="o">=</span> <span class="n">OV</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">OV_tab</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_OV&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_kP1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tab1</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kPol</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">tab1</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_kP1&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_kP2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">tab2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kPol</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">tab2</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_kP2&#39;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_kP3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tab3</span> <span class="o">=</span> <span class="n">kPol</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">tab3</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_kP3&#39;</span>
        <span class="k">return</span> <span class="n">result</span>    
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_RSDA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tabA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span> <span class="o">=</span> <span class="n">RSDA</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">tabA</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_RSDA&#39;</span>  
        <span class="k">return</span> <span class="n">result</span>    
    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">X_RSDB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tabB</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span> <span class="o">=</span> <span class="n">RSDB</span><span class="p">()</span>
        <span class="n">p_mat</span> <span class="o">=</span> <span class="n">tabB</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tensor_stuff</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta_m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_l</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;X_RSDB&#39;</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot; Same function as before &quot;&quot;&quot;</span>
        <span class="c1">#Would need to add checks for every possible parameter (f, nu, X, etc)</span>
        <span class="n">valid_params</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P_window&#39;</span><span class="p">,</span> <span class="s1">&#39;C_window&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;nu&#39;</span><span class="p">,</span> <span class="s1">&#39;mu_n&#39;</span><span class="p">,</span> <span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;rsdrag&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid parameter: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">. Valid parameters are: </span><span class="si">{</span><span class="n">valid_params</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must provide an input power spectrum array.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Input k and P arrays must have the same size. P:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="si">}</span><span class="s1">, K:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">P</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Your input power spectrum array is all zeros.&#39;</span><span class="p">)</span>

        <span class="n">P_window</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;P_window&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
        <span class="n">C_window</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;C_window&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">P_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_window</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">maxP</span> <span class="o">=</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_final</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_final</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_window</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P_window must be a tuple of two values.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxP</span> <span class="ow">or</span> <span class="n">P_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxP</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;P_window value is too large. Decrease to less than </span><span class="si">{</span><span class="n">maxP</span><span class="si">}</span><span class="s1"> to avoid over tapering.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">C_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_window</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">C_window</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;C_window must be between 0 and 1.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span>
    
    <span class="c1">############## ABSTRACTED BEHAVIOR METHODS ##############</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_extrapolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Applies extrapolation to multiple variables at once &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">args</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">PK_original</span><span class="p">(</span><span class="n">var</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">PK_original</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hash_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrays</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to create a hash from multiple numpy arrays or scalars&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">arrays</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">hash_key_hash</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="c1"># Use a prime multiplier to avoid collisions</span>
                    <span class="n">item_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="c1"># Recursively compute hash of nested structure</span>
                    <span class="n">item_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_arrays</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">item_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="c1"># Combine hashes using a prime-based approach to reduce collisions</span>
                <span class="n">hash_key_hash</span> <span class="o">=</span> <span class="n">hash_key_hash</span> <span class="o">^</span> <span class="p">(</span><span class="n">item_hash</span> <span class="o">+</span> <span class="mh">0x9e3779b9</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key_hash</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key_hash</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">hash_key_hash</span>

        <span class="c1"># Single item case</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arrays</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arrays</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_hash_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a hash key from the term and input parameters&quot;&quot;&quot;</span>
        <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_arrays</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">P_win_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash_arrays</span><span class="p">(</span><span class="n">P_window</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X_id</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_id</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;unknown_</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="n">term_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c1">#Included for differentiating between similar param sets</span>
        <span class="n">hash_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">term_hash</span><span class="p">,</span> <span class="n">X_id</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">,</span> <span class="n">P_win_hash</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">C_window</span><span class="p">)]</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hash_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hash_key</span> <span class="o">=</span> <span class="n">hash_key</span> <span class="o">^</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mh">0x9e3779b9</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span>

<div class="viewcode-block" id="FASTPT.compute_term">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.compute_term">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a Fast-PT term with caching support.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        term : str</span>
<span class="sd">            Name of the term to compute, used for cache identification</span>
<span class="sd">        X : tuple</span>
<span class="sd">            Fast-PT coefficient matrices for the calculation</span>
<span class="sd">        operation : callable, optional</span>
<span class="sd">            Function to apply to the result(s) after computation</span>
<span class="sd">        P : array_like</span>
<span class="sd">            Input power spectrum</span>
<span class="sd">        P_window : tuple, optional</span>
<span class="sd">            Window parameters for tapering the power spectrum at the endpoints</span>
<span class="sd">        C_window : float, optional</span>
<span class="sd">            Window parameter for tapering the Fourier coefficients</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like</span>
<span class="sd">            The computed Fast-PT term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Compute term requires an input power spectrum array.&#39;</span><span class="p">)</span>        

        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">operation</span><span class="p">:</span>
            <span class="n">final_result</span> <span class="o">=</span> <span class="n">operation</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">final_result</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">final_result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

    



    <span class="c1">### Top-level functions to output final quantities ###</span>
<div class="viewcode-block" id="FASTPT.one_loop_dd">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.one_loop_dd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_loop_dd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the standard 1-loop density-density corrections to the power spectrum.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_1loop, Ps) where:</span>
<span class="sd">        P_1loop : 1-loop correction (P_22 + P_13)</span>
<span class="sd">        Ps : Smoothed input power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_1loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_1loop</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_1loop</span><span class="p">,</span> <span class="n">Ps</span> <span class="c1">#This return is going to be different than the original bc the original return is </span></div>

                        <span class="c1"># different depending on the todo list which is going to be deprecated.</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Ps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Ps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ps</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_1loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_1loop&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_1loop&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P22_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="mi">1219</span><span class="o">/</span><span class="mf">1470.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">671</span><span class="o">/</span><span class="mf">1029.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">32</span><span class="o">/</span><span class="mf">1715.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">62</span><span class="o">/</span><span class="mf">35.</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mf">35.</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">])</span>
        <span class="n">P22_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">P22_coef</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
        <span class="n">P22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P22_mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">P13</span> <span class="o">=</span> <span class="n">P_13_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
        <span class="n">P_1loop</span> <span class="o">=</span> <span class="n">P22</span> <span class="o">+</span> <span class="n">P13</span>
        <span class="n">P_1loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_1loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_1loop</span><span class="p">,</span> <span class="s2">&quot;P_1loop&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_1loop</span>


    <span class="c1">#TODO add comments back explaining math behind one loop</span>
<div class="viewcode-block" id="FASTPT.one_loop_dd_bias">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.one_loop_dd_bias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_loop_dd_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes 1-loop corrections with standard bias terms.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_1loop, Ps, Pd1d2, Pd2d2, Pd1s2, Pd2s2, Ps2s2, sig4) where:</span>
<span class="sd">        P_1loop : 1-loop correction (P_22 + P_13)</span>
<span class="sd">        Ps : Smoothed input power spectrum</span>
<span class="sd">        Pd1d2 : First order density-second order density correlation</span>
<span class="sd">        Pd2d2 : Second order density auto-correlation</span>
<span class="sd">        Pd1s2 : First order density-second order tidal correlation</span>
<span class="sd">        Pd2s2 : Second order density-second order tidal correlation</span>
<span class="sd">        Ps2s2 : Second order tidal auto-correlation</span>
<span class="sd">        sig4 : σ^4 integral for stochastic bias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">P_1loop</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_loop_dd</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd1d2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd2d2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd1s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd2s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Ps2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps2s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sig4</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_1loop</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">Pd1d2</span><span class="p">,</span> <span class="n">Pd2d2</span><span class="p">,</span> <span class="n">Pd1s2</span><span class="p">,</span> <span class="n">Pd2s2</span><span class="p">,</span> <span class="n">Ps2s2</span><span class="p">,</span> <span class="n">sig4</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sig4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;sig4&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig4&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">Ps</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sig4</span><span class="p">,</span> <span class="s2">&quot;sig4&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sig4</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pd1d2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pd1d2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pd1d2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1d2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">17.</span> <span class="o">/</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Pd1d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pd1d2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pd1d2</span><span class="p">,</span> <span class="s2">&quot;Pd1d2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pd1d2</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pd2d2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pd2d2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pd2d2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2d2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Pd2d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pd2d2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pd2d2</span><span class="p">,</span> <span class="s2">&quot;Pd2d2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pd2d2</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pd1s2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pd1s2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pd1s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1s2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">/</span> <span class="mi">315</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">4.</span> <span class="o">/</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">254.</span> <span class="o">/</span> <span class="mi">441</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span>
                                                                                                     <span class="p">:]</span> <span class="o">+</span> <span class="mf">16.</span> <span class="o">/</span> <span class="mi">245</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span>
                                                                                                                      <span class="mi">2</span><span class="p">,</span>
                                                                                                                      <span class="p">:])</span>
        <span class="n">Pd1s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pd1s2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pd1s2</span><span class="p">,</span> <span class="s2">&quot;Pd1s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pd1s2</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pd2s2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pd2s2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pd2s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pd2s2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pd2s2</span><span class="p">,</span> <span class="s2">&quot;Pd2s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pd2s2</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Ps2s2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Ps2s2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Ps2s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">/</span> <span class="mi">45</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">8.</span> <span class="o">/</span> <span class="mi">63</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">8.</span> <span class="o">/</span> <span class="mi">35</span> <span class="o">*</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pd2s2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pd2s2</span><span class="p">,</span> <span class="s2">&quot;Ps2s2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pd2s2</span>

    
<div class="viewcode-block" id="FASTPT.one_loop_dd_bias_b3nl">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.one_loop_dd_bias_b3nl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_loop_dd_bias_b3nl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes 1-loop corrections with bias terms including third-order non-local bias.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_1loop, Ps, Pd1d2, Pd2d2, Pd1s2, Pd2s2, Ps2s2, sig4, sig3nl) where:</span>
<span class="sd">        The first 8 terms are identical to those returned by one_loop_dd_bias</span>
<span class="sd">        sig3nl : Third order non-local bias term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_1loop</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_loop_dd</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd1d2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd2d2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd1s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd1s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pd2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pd2s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Ps2s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Ps2s2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sig4</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig3nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sig3nl</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_1loop</span><span class="p">,</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">Pd1d2</span><span class="p">,</span> <span class="n">Pd2d2</span><span class="p">,</span> <span class="n">Pd1s2</span><span class="p">,</span> <span class="n">Pd2s2</span><span class="p">,</span> <span class="n">Ps2s2</span><span class="p">,</span> <span class="n">sig4</span><span class="p">,</span> <span class="n">sig3nl</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sig3nl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;sig3nl&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sig3nl&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig3nl</span> <span class="o">=</span> <span class="n">Y1_reg_NL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
        <span class="n">sig3nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">sig3nl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sig3nl</span><span class="p">,</span> <span class="s2">&quot;sig3nl&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sig3nl</span>

    
<div class="viewcode-block" id="FASTPT.one_loop_dd_bias_lpt_NL">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.one_loop_dd_bias_lpt_NL">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_loop_dd_bias_lpt_NL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes bias corrections in Lagrangian Perturbation Theory (LPT).</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (Ps, Pb1L, Pb1L_2, Pb1L_b2L, Pb2L, Pb2L_2, sig4) where:</span>
<span class="sd">        Ps : Smoothed input power spectrum</span>
<span class="sd">        Pb1L : First-order Lagrangian bias correlation term</span>
<span class="sd">        Pb1L_2 : First-order Lagrangian bias squared correlation</span>
<span class="sd">        Pb1L_b2L : First-order and second-order Lagrangian bias cross-correlation</span>
<span class="sd">        Pb2L : Second-order Lagrangian bias correlation</span>
<span class="sd">        Pb2L_2 : Second-order Lagrangian bias squared correlation </span>
<span class="sd">        sig4 : σ^4 integral for stochastic bias</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">Ps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_loop_dd</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pb1L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pb1L</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pb1L_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pb1L_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pb1L_b2L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pb1L_b2L</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pb2L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pb2L</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">Pb2L_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_Pb2L_2</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">sig4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sig4</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Ps</span><span class="p">,</span> <span class="n">Pb1L</span><span class="p">,</span> <span class="n">Pb1L_2</span><span class="p">,</span> <span class="n">Pb1L_b2L</span><span class="p">,</span> <span class="n">Pb2L</span><span class="p">,</span> <span class="n">Pb2L_2</span><span class="p">,</span> <span class="n">sig4</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pb1L</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pb1L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pb1L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j2n22</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j2n20</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="n">X1</span> <span class="o">=</span> <span class="p">((</span><span class="mf">144.</span> <span class="o">/</span> <span class="mf">245.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">176.</span> <span class="o">/</span> <span class="mf">343.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j002</span> <span class="o">-</span> <span class="p">(</span><span class="mf">128.</span> <span class="o">/</span> <span class="mf">1715.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j004</span> <span class="o">+</span> <span class="p">(</span><span class="mf">16.</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1n11</span> <span class="o">-</span> <span class="p">(</span>
                <span class="mf">16.</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1n13</span><span class="p">)</span>
        <span class="n">Y1</span> <span class="o">=</span> <span class="n">Y1_reg_NL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
        <span class="n">Pb1L</span> <span class="o">=</span> <span class="n">X1</span> <span class="o">+</span> <span class="n">Y1</span>
        <span class="n">Pb1L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pb1L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pb1L</span><span class="p">,</span> <span class="s2">&quot;Pb1L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pb1L</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pb1L_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pb1L_2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pb1L_2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j2n22</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j2n20</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="n">X2</span> <span class="o">=</span> <span class="p">((</span><span class="mf">16.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">16.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j002</span> <span class="o">+</span> <span class="p">(</span><span class="mf">16.</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1n11</span> <span class="o">-</span> <span class="p">(</span><span class="mf">16.</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j1n13</span><span class="p">)</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y2_reg_NL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
        <span class="n">Pb1L_2</span> <span class="o">=</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">Y2</span>
        <span class="n">Pb1L_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pb1L_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pb1L_2</span><span class="p">,</span> <span class="s2">&quot;Pb1L_2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pb1L_2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pb1L_b2L</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pb1L_b2L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pb1L_b2L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j2n22</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j2n20</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="n">X3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">50.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j000</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">j1n11</span> <span class="o">-</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j002</span>
        <span class="n">Pb1L_b2L</span> <span class="o">=</span> <span class="n">X3</span>
        <span class="n">Pb1L_b2L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pb1L_b2L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pb1L_b2L</span><span class="p">,</span> <span class="s2">&quot;Pb1L_b2L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pb1L_b2L</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pb2L</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pb2L&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pb2L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j2n22</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j2n20</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="n">X4</span> <span class="o">=</span> <span class="p">(</span><span class="mf">34.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j000</span> <span class="o">+</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">j1n11</span> <span class="o">+</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">/</span> <span class="mf">21.</span><span class="p">)</span> <span class="o">*</span> <span class="n">j002</span>
        <span class="n">Pb2L</span> <span class="o">=</span> <span class="n">X4</span>
        <span class="n">Pb2L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pb2L</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pb2L</span><span class="p">,</span> <span class="s2">&quot;Pb2L&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pb2L</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_Pb2L_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pb2L_2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pb2L_2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_lpt</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j2n22</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j2n20</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="n">X5</span> <span class="o">=</span> <span class="n">j000</span>
        <span class="n">Pb2L_2</span> <span class="o">=</span> <span class="n">X5</span>
        <span class="n">Pb2L_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Pb2L_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">Pb2L_2</span><span class="p">,</span> <span class="s2">&quot;Pb2L_2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Pb2L_2</span>
    
<div class="viewcode-block" id="FASTPT.cleft_Q_R">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.cleft_Q_R">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleft_Q_R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>


        <span class="n">nu_arr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="c1"># get the roundtrip Fourier power spectrum, i.e. P=IFFT[FFT[P]]</span>
        <span class="c1"># get the matrix for each J_k component</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_cleft</span><span class="p">,</span> <span class="n">nu_arr</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>

        <span class="p">[</span><span class="n">j000</span><span class="p">,</span> <span class="n">j002</span><span class="p">,</span> <span class="n">j004</span><span class="p">,</span> <span class="n">j1n11</span><span class="p">,</span> <span class="n">j1n13</span><span class="p">,</span> <span class="n">jn111</span><span class="p">,</span> <span class="n">jn113</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:],</span>
                                                          <span class="n">mat</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mat</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]]</span>

        <span class="n">FQ1</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">15.</span><span class="p">)</span><span class="o">*</span><span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">16.</span><span class="o">/</span><span class="mf">21.</span><span class="p">)</span><span class="o">*</span><span class="n">j002</span> <span class="o">+</span> <span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">35.</span><span class="p">)</span><span class="o">*</span><span class="n">j004</span>
        <span class="n">FQ2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">7.</span><span class="p">)</span><span class="o">*</span><span class="n">j002</span> <span class="o">-</span> <span class="p">(</span><span class="mf">8.</span><span class="o">/</span><span class="mf">35.</span><span class="p">)</span><span class="o">*</span><span class="n">j004</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">j1n11</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">j1n13</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">jn111</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">jn113</span>
        <span class="n">FQ5</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">j002</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">jn111</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">jn113</span>
        <span class="n">FQ8</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">j000</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">*</span><span class="n">j002</span>
        <span class="n">FQs2</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="o">/</span><span class="mf">15.</span><span class="p">)</span><span class="o">*</span><span class="n">j000</span> <span class="o">+</span> <span class="p">(</span><span class="mf">20.</span><span class="o">/</span><span class="mf">21.</span><span class="p">)</span><span class="o">*</span><span class="n">j002</span> <span class="o">-</span> <span class="p">(</span><span class="mf">24.</span><span class="o">/</span><span class="mf">35.</span><span class="p">)</span><span class="o">*</span><span class="n">j004</span>


        <span class="n">FR1</span> <span class="o">=</span> <span class="n">cleft_Z1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>
        <span class="n">FR2</span> <span class="o">=</span> <span class="n">cleft_Z2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">Ps</span><span class="p">)</span>

        <span class="c1"># ipdb.set_trace()</span>

        <span class="n">Ps_ep</span><span class="p">,</span> <span class="n">FQ1_ep</span><span class="p">,</span> <span class="n">FQ2_ep</span><span class="p">,</span> <span class="n">FQ5_ep</span><span class="p">,</span> <span class="n">FQ8_ep</span><span class="p">,</span> <span class="n">FQs2_ep</span><span class="p">,</span> <span class="n">FR1_ep</span><span class="p">,</span> <span class="n">FR2_ep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">Ps</span><span class="p">,</span> <span class="n">FQ1</span><span class="p">,</span> <span class="n">FQ2</span><span class="p">,</span> <span class="n">FQ5</span><span class="p">,</span> <span class="n">FQ8</span><span class="p">,</span> <span class="n">FQs2</span><span class="p">,</span> <span class="n">FR1</span><span class="p">,</span> <span class="n">FR2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FQ1_ep</span><span class="p">,</span><span class="n">FQ2_ep</span><span class="p">,</span><span class="n">FQ5_ep</span><span class="p">,</span><span class="n">FQ8_ep</span><span class="p">,</span><span class="n">FQs2_ep</span><span class="p">,</span><span class="n">FR1_ep</span><span class="p">,</span><span class="n">FR2_ep</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span><span class="n">FR1</span><span class="p">,</span><span class="n">FR2</span></div>


<div class="viewcode-block" id="FASTPT.IA_tt">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IA_tt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IA_tt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes intrinsic alignment tidal torque contributions.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_E, P_B) where:</span>
<span class="sd">        P_E : E-mode (curl-free) tidal torque power spectrum</span>
<span class="sd">        P_B : B-mode (divergence-free) tidal torque power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_E</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                 <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_B</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                 <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_E</span><span class="p">,</span> <span class="n">P_B</span></div>


    <span class="c1">## eq 21 EE; eq 21 BB</span>

<div class="viewcode-block" id="FASTPT.IA_mix">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IA_mix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IA_mix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes mixed intrinsic alignment contributions combining tidal </span>
<span class="sd">        alignment and tidal torque.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_A, P_Btype2, P_DEE, P_DBB) where:</span>
<span class="sd">        P_A : Mixed tidal alignment/tidal torque term</span>
<span class="sd">        P_Btype2 : Second-type B-mode term</span>
<span class="sd">        P_DEE : Contribution to the E-mode power spectrum</span>
<span class="sd">        P_DBB : Contribution to the B-mode power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_A&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_A</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                 <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_Btype2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_Btype2</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="c1">#Calculated differently then other terms, can&#39;t use compute_term</span>
        <span class="n">P_DEE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_DEE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_DEE</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                   <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_DBB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_DBB&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_DBB</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                   <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_A</span><span class="p">,</span> <span class="n">P_Btype2</span><span class="p">,</span> <span class="n">P_DEE</span><span class="p">,</span> <span class="n">P_DBB</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_Btype2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_Btype2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_Btype2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_Btype2</span> <span class="o">=</span> <span class="n">P_IA_B</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">P_Btype2</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">P_Btype2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_Btype2</span><span class="p">,</span> <span class="s2">&quot;P_Btype2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_Btype2</span>

    <span class="c1">## eq 18; eq 19; eq 27 EE; eq 27 BB</span>

    
<div class="viewcode-block" id="FASTPT.IA_ta">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IA_ta">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IA_ta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes intrinsic alignment tidal alignment contributions.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_deltaE1, P_deltaE2, P_0E0E, P_0B0B) where:</span>
<span class="sd">        P_deltaE1 : First density-E mode correlation</span>
<span class="sd">        P_deltaE2 : Second density-E mode correlation</span>
<span class="sd">        P_0E0E : E-mode auto-correlation</span>
<span class="sd">        P_0B0B : B-mode auto-correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_deltaE1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_deltaE1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_deltaE1</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                       <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_deltaE2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_deltaE2</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="c1">#Calculated differently then other terms, can&#39;t use compute_term</span>
        <span class="n">P_0E0E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_0E0E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_0E0E</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_0B0B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_0B0B&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_0B0B</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_deltaE1</span><span class="p">,</span> <span class="n">P_deltaE2</span><span class="p">,</span> <span class="n">P_0E0E</span><span class="p">,</span> <span class="n">P_0B0B</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_deltaE2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_deltaE2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_deltaE2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_deltaE2</span> <span class="o">=</span> <span class="n">P_IA_deltaE2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="c1">#Add extrap?</span>
        <span class="n">P_deltaE2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">P_deltaE2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_deltaE2</span><span class="p">,</span> <span class="s2">&quot;P_deltaE2&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_deltaE2</span>

    <span class="c1">## eq 12 (line 2); eq 12 (line 3); eq 15 EE; eq 15 BB</span>

    
<div class="viewcode-block" id="FASTPT.IA_der">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IA_der">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IA_der</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes k^2 * P(k) derivative term for intrinsic alignment models.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like</span>
<span class="sd">            P_der : Derivative term of the power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;IA_der&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IA_der&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_der</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_der</span><span class="p">,</span> <span class="s2">&quot;IA_der&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_der</span></div>

    
<div class="viewcode-block" id="FASTPT.IA_ct">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IA_ct">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IA_ct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes intrinsic alignment velocity-shear contributions.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_0tE, P_0EtE, P_E2tE, P_tEtE) where:</span>
<span class="sd">        P_0tE : Density-velocity E-mode correlation</span>
<span class="sd">        P_0EtE : E-mode-velocity E-mode correlation</span>
<span class="sd">        P_E2tE : Second torquing-velocity E-mode correlation</span>
<span class="sd">        P_tEtE : Velocity E-mode auto-correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_0tE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_0tE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_0EtE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_0EtE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_E2tE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_E2tE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_tEtE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_tEtE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_0tE</span><span class="p">,</span><span class="n">P_0EtE</span><span class="p">,</span><span class="n">P_E2tE</span><span class="p">,</span><span class="n">P_tEtE</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_0tE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_0tE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_0tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">nu</span><span class="o">=-</span><span class="mi">2</span>
        <span class="n">Ps</span><span class="p">,</span> <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">one_loop_coef</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1219</span> <span class="o">/</span> <span class="mf">1470.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">671</span> <span class="o">/</span> <span class="mf">1029.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="mf">1715.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">62</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mf">35.</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">])</span>
        <span class="n">P22_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">one_loop_coef</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
        <span class="n">P_22F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P22_mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">one_loop_coefG</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="mi">1003</span><span class="o">/</span><span class="mi">1470</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">803</span><span class="o">/</span><span class="mi">1029</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">64</span><span class="o">/</span><span class="mi">1715</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">58</span><span class="o">/</span><span class="mi">35</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">12</span><span class="o">/</span><span class="mi">35</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">PsG</span><span class="p">,</span> <span class="n">matG</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_scalar</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_sptG</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P22G_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">one_loop_coefG</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">matG</span><span class="p">))</span>
        <span class="n">P_22G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">P22G_mat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">P_22F</span><span class="p">,</span> <span class="n">P_22G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_22F</span><span class="p">,</span> <span class="n">P_22G</span><span class="p">)</span>
        <span class="n">P_13G</span> <span class="o">=</span> <span class="n">P_IA_13G</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span><span class="n">P</span><span class="p">,)</span>
        <span class="n">P_13F</span> <span class="o">=</span> <span class="n">P_IA_13F</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">P_0tE</span> <span class="o">=</span> <span class="n">P_22G</span><span class="o">-</span><span class="n">P_22F</span><span class="o">+</span><span class="n">P_13G</span><span class="o">-</span><span class="n">P_13F</span>
        <span class="n">P_0tE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P_0tE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_0tE</span><span class="p">,</span> <span class="s2">&quot;P_0tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_0tE</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_0EtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_0EtE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_0EtE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_feG2</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_feG2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_feG2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_feG2</span><span class="p">)</span>
        <span class="n">P_A00E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_deltaE1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_deltaE1</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                       <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span> <span class="c1">#OG: P_A00E, _, _, _ = self.IA_ta()</span>
        <span class="n">P_0EtE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">P_feG2</span><span class="p">,(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">P_A00E</span><span class="p">)</span>
        <span class="n">P_0EtE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P_0EtE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_0EtE</span><span class="p">,</span> <span class="s2">&quot;P_0EtE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_0EtE</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_E2tE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_E2tE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_E2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_heG2</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_heG2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_heG2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_heG2</span><span class="p">)</span>
        <span class="n">P_A0E2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_A&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_A</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span> 
                                 <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span> <span class="c1">#OG: P_A0E2, _, _, _ = self.IA_mix()</span>
        <span class="n">P_E2tE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">P_heG2</span><span class="p">,(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">P_A0E2</span><span class="p">)</span>
        <span class="n">P_E2tE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P_E2tE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_E2tE</span><span class="p">,</span> <span class="s2">&quot;P_E2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_E2tE</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_tEtE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_tEtE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_spt</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_tEtE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_F2F2</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_F2F2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_G2G2</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_G2G2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_F2G2</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X_IA_tij_F2G2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_F2F2</span><span class="p">,</span> <span class="n">P_G2G2</span><span class="p">,</span> <span class="n">P_F2G2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_F2F2</span><span class="p">,</span> <span class="n">P_G2G2</span><span class="p">,</span> <span class="n">P_F2G2</span><span class="p">)</span>
        <span class="n">P_tEtE</span> <span class="o">=</span> <span class="n">P_F2F2</span><span class="o">+</span><span class="n">P_G2G2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">P_F2G2</span>
        <span class="n">P_tEtE</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">P_tEtE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_tEtE</span><span class="p">,</span> <span class="s2">&quot;P_tEtE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_tEtE</span>

<div class="viewcode-block" id="FASTPT.gI_ct">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.gI_ct">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gI_ct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes galaxy bias cross intrinsic alignment velocity-shear contributions.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_d2tE, P_s2tE) where:</span>
<span class="sd">        P_d2tE : Second-order density-velocity E-mode correlation</span>
<span class="sd">        P_s2tE : Second-order tidal-velocity E-mode correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_d2tE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_d2tE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_s2tE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_s2tE</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_d2tE</span><span class="p">,</span> <span class="n">P_s2tE</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_d2tE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;Pd2tE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_F2</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pd2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_F2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_F2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_G2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_G2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_F2</span><span class="p">,</span> <span class="n">P_G2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_F2</span><span class="p">,</span> <span class="n">P_G2</span><span class="p">)</span>
        <span class="n">P_d2tE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_G2</span> <span class="o">-</span> <span class="n">P_F2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_d2tE</span><span class="p">,</span> <span class="s2">&quot;Pd2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_d2tE</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_P_s2tE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;P_s2tE&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2F2</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_s2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P_S2F2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2F2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_S2G2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2G2</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_S2F2</span><span class="p">,</span> <span class="n">P_S2G2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P_S2F2</span><span class="p">,</span> <span class="n">P_S2G2</span><span class="p">)</span>
        <span class="n">P_s2tE</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">P_S2G2</span> <span class="o">-</span> <span class="n">P_S2F2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_s2tE</span><span class="p">,</span> <span class="s2">&quot;P_s2tE&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_s2tE</span>
    
<div class="viewcode-block" id="FASTPT.gI_ta">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.gI_ta">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gI_ta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes intrinsic alignment 2nd-order density correlations.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_d2E, P_d20E, P_d2E2) where:</span>
<span class="sd">        P_d2E : 2nd-order density-E-mode correlation</span>
<span class="sd">        P_d20E : 2nd-order density-density-E-mode correlation</span>
<span class="sd">        P_d2E2 : 2nd-order density-E-mode squared correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_d2E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_d2E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_F2</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                   <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_d20E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_d20E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_fe</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                    <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_s2E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_s2E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2F2</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                   <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_s20E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_s20E&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2fe</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                    <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_d2E</span><span class="p">,</span> <span class="n">P_d20E</span><span class="p">,</span> <span class="n">P_s2E</span><span class="p">,</span> <span class="n">P_s20E</span></div>


<div class="viewcode-block" id="FASTPT.gI_tt">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.gI_tt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gI_tt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes intrinsic alignment 2nd-order tidal correlations.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P_s2E, P_s20E, P_s2E2) where:</span>
<span class="sd">        P_s2E : 2nd-order tidal-E-mode correlation</span>
<span class="sd">        P_s20E : 2nd-order tidal-density-E-mode correlation</span>
<span class="sd">        P_s2E2 : 2nd-order tidal-E-mode squared correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_s2E2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_s2E2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_S2he</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                    <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P_d2E2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_d2E2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_IA_gb2_he</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                                    <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_s2E2</span><span class="p">,</span> <span class="n">P_d2E2</span></div>


    
<div class="viewcode-block" id="FASTPT.OV">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.OV">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">OV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Ostriker-Vishniac effect power spectrum.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like</span>
<span class="sd">            P_OV : Ostriker-Vishniac effect power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;OV&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;P_OV&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>
        <span class="n">P</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_OV</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">P_OV</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">P_OV</span><span class="p">,</span> <span class="s2">&quot;P_OV&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_OV</span></div>


    
<div class="viewcode-block" id="FASTPT.kPol">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.kPol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">kPol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes k-dependent polarization power spectra.</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (P1, P2, P3) where:</span>
<span class="sd">        P1 : First k-dependent polarization power spectrum</span>
<span class="sd">        P2 : Second k-dependent polarization power spectrum</span>
<span class="sd">        P3 : Third k-dependent polarization power spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_kP1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_kP1</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_kP2&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_kP2</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">160</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">P3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_term</span><span class="p">(</span><span class="s2">&quot;P_kP3&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_kP3</span><span class="p">,</span> <span class="n">operation</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="mi">80</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
                                <span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P1</span><span class="p">,</span> <span class="n">P2</span><span class="p">,</span> <span class="n">P3</span></div>



<div class="viewcode-block" id="FASTPT.RSD_components">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.RSD_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">RSD_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes redshift-space distortion component terms.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : float</span>
<span class="sd">            Logarithmic growth rate</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (A1, A3, A5, B0, B2, B4, B6, P_Ap1, P_Ap3, P_Ap5) where:</span>
<span class="sd">        A1, A3, A5 : A-type RSD components with different powers of μ</span>
<span class="sd">        B0, B2, B4, B6 : B-type RSD components with different powers of μ</span>
<span class="sd">        P_Ap1, P_Ap3, P_Ap5 : Additional RSD A-prime components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_RSDA</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>

        <span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">A5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_coeff</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">A</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">J_k_tensor</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_RSDB</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>

        <span class="n">B0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">B2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">B4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">B6</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">9</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_coeff</span><span class="p">[:,</span> <span class="mi">11</span><span class="p">],</span> <span class="n">B</span><span class="p">)</span>

        <span class="n">A1</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A5</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B4</span><span class="p">,</span> <span class="n">B6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_extrapolation</span><span class="p">(</span><span class="n">A1</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A5</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B4</span><span class="p">,</span> <span class="n">B6</span><span class="p">)</span>

        <span class="n">P_Ap1</span> <span class="o">=</span> <span class="n">RSD_ItypeII</span><span class="o">.</span><span class="n">P_Ap1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">P_Ap3</span> <span class="o">=</span> <span class="n">RSD_ItypeII</span><span class="o">.</span><span class="n">P_Ap3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">P_Ap5</span> <span class="o">=</span> <span class="n">RSD_ItypeII</span><span class="o">.</span><span class="n">P_Ap5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A5</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B4</span><span class="p">,</span> <span class="n">B6</span><span class="p">,</span> <span class="n">P_Ap1</span><span class="p">,</span> <span class="n">P_Ap3</span><span class="p">,</span> <span class="n">P_Ap5</span></div>


    
<div class="viewcode-block" id="FASTPT.RSD_ABsum_components">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.RSD_ABsum_components">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">RSD_ABsum_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes combined redshift-space distortion terms by powers of μ.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : float</span>
<span class="sd">            Logarithmic growth rate</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">            (ABsum_mu2, ABsum_mu4, ABsum_mu6, ABsum_mu8) where:</span>
<span class="sd">        ABsum_mu2 : Combined term with μ^2 dependence</span>
<span class="sd">        ABsum_mu4 : Combined term with μ^4 dependence</span>
<span class="sd">        ABsum_mu6 : Combined term with μ^6 dependence</span>
<span class="sd">        ABsum_mu8 : Combined term with μ^8 dependence</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">A1</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A5</span><span class="p">,</span> <span class="n">B0</span><span class="p">,</span> <span class="n">B2</span><span class="p">,</span> <span class="n">B4</span><span class="p">,</span> <span class="n">B6</span><span class="p">,</span> <span class="n">P_Ap1</span><span class="p">,</span> <span class="n">P_Ap3</span><span class="p">,</span> <span class="n">P_Ap5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RSD_components</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">ABsum_mu2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">A1</span> <span class="o">+</span> <span class="n">P_Ap1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B0</span>
        <span class="n">ABsum_mu4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">A3</span> <span class="o">+</span> <span class="n">P_Ap3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B2</span>
        <span class="n">ABsum_mu6</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">A5</span> <span class="o">+</span> <span class="n">P_Ap5</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B4</span>
        <span class="n">ABsum_mu8</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">B6</span>

        <span class="k">return</span> <span class="n">ABsum_mu2</span><span class="p">,</span> <span class="n">ABsum_mu4</span><span class="p">,</span> <span class="n">ABsum_mu6</span><span class="p">,</span> <span class="n">ABsum_mu8</span></div>


    
<div class="viewcode-block" id="FASTPT.RSD_ABsum_mu">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.RSD_ABsum_mu">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">RSD_ABsum_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mu_n</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total redshift-space distortion correction at a given μ.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f : float</span>
<span class="sd">            Logarithmic growth rate</span>
<span class="sd">        mu_n : float</span>
<span class="sd">            Cosine of the angle between the wavevector and the line-of-sight</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like</span>
<span class="sd">            ABsum : The total RSD contribution at the specified μ angle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="n">ABsum_mu2</span><span class="p">,</span> <span class="n">ABsum_mu4</span><span class="p">,</span> <span class="n">ABsum_mu6</span><span class="p">,</span> <span class="n">ABsum_mu8</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RSD_ABsum_components</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">ABsum</span> <span class="o">=</span> <span class="n">ABsum_mu2</span> <span class="o">*</span> <span class="n">mu_n</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ABsum_mu4</span> <span class="o">*</span> <span class="n">mu_n</span> <span class="o">**</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">ABsum_mu6</span> <span class="o">*</span> <span class="n">mu_n</span> <span class="o">**</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">ABsum_mu8</span> <span class="o">*</span> <span class="n">mu_n</span> <span class="o">**</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">ABsum</span></div>


    
<div class="viewcode-block" id="FASTPT.IRres">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.IRres">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">IRres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.67</span><span class="p">,</span> <span class="n">rsdrag</span><span class="o">=</span><span class="mi">135</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the IR-resummed power spectrum, which includes BAO damping.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        L : float, optional</span>
<span class="sd">            IR resummation scale, default is 0.2</span>
<span class="sd">        h : float, optional</span>
<span class="sd">            Dimensionless Hubble parameter, default is 0.67</span>
<span class="sd">        rsdrag : float, optional</span>
<span class="sd">            Sound horizon at drag epoch in Mpc, default is 135</span>
<span class="sd">    </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        array_like</span>
<span class="sd">            P_IRres : IR-resummed power spectrum with damped BAO features</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_params</span><span class="p">(</span><span class="n">P</span><span class="o">=</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="c1"># based on script by M. Ivanov. See arxiv:1605.02149, eq 7.4</span>

        <span class="c1"># put this function in the typical fast-pt format, with minimal additional function calls.</span>
        <span class="c1"># We can also include a script to do additional things: e.g read in r_BAO from class/camb output</span>
        <span class="c1"># or calculate r_BAO from cosmological params.</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_original</span>
        <span class="n">rbao</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">rsdrag</span> <span class="o">*</span> <span class="mf">1.027</span>  <span class="c1"># linear BAO scale</span>
        <span class="c1"># set up splining to create P_nowiggle</span>
        <span class="n">kmin</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">knode1</span> <span class="o">=</span> <span class="n">pi</span> <span class="o">/</span> <span class="n">rbao</span>
        <span class="n">knode2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="n">rbao</span>
        <span class="n">klogleft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">kmin</span><span class="p">),</span> <span class="n">log</span><span class="p">(</span><span class="mf">3.e-3</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">)</span>
        <span class="n">klogright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mf">0.6</span><span class="p">),</span> <span class="n">log</span><span class="p">(</span><span class="n">kmax</span><span class="p">),</span> <span class="mf">0.085</span><span class="p">)</span>
        <span class="n">klogright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">log</span><span class="p">(</span><span class="n">knode1</span><span class="p">),</span> <span class="n">log</span><span class="p">(</span><span class="n">knode2</span><span class="p">),</span> <span class="n">klogright</span><span class="p">))</span>
        <span class="n">kloglist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">klogleft</span><span class="p">,</span> <span class="n">klogright</span><span class="p">))</span>
        <span class="n">klist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kloglist</span><span class="p">)</span>

        <span class="c1"># how to deal with extended k and P? which values should be used here? probably the extended versions?</span>
        <span class="n">plin</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
        <span class="n">logPs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">plin</span><span class="p">(</span><span class="n">klist</span><span class="p">))</span>
        <span class="n">logpsmooth</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">kloglist</span><span class="p">,</span> <span class="n">logPs</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">psmooth</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">exp</span><span class="p">(</span><span class="n">logpsmooth</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">pw</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">plin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">psmooth</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># compute Sigma^2 and the tree-level IR-resummed PS</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">scipy.integrate</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">integrate</span>

        <span class="n">Sigma</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">psmooth</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rbao</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">rbao</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rbao</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">rbao</span> <span class="o">*</span> <span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">x</span> <span class="o">*</span> <span class="n">rbao</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">),</span> <span class="n">kmin</span><span class="p">,</span> <span class="n">L</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># speed up by using trap rule integration?</span>
        <span class="c1"># change to integration over log-k(?):</span>
        <span class="c1"># 		Sigma = integrate.quad(lambda x: x*(4*pi)*psmooth(x)*(1-3*(2*rbao*x*cos(x*rbao)+(-2+rbao**2*x**2)*sin(rbao*x))/(x*rbao)**3)/(3*(2*pi)**3), np.log(kmin), np.log(L))[0]</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">presum</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">psmooth</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">pw</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Sigma</span><span class="p">)</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">presum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">out_1loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_P_1loop</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span>
        <span class="c1"># p1loop = interpolate.InterpolatedUnivariateSpline(k,out_1loop) # is this necessary? out_1loop should already be at the correct k spacing</span>
        <span class="k">return</span> <span class="n">psmooth</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">out_1loop</span> <span class="o">+</span> <span class="n">pw</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Sigma</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">Sigma</span> <span class="o">*</span> <span class="n">k</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span></div>


    <span class="c1">######################################################################################</span>
    <span class="c1">### functions that use the older version structures. ###</span>
    
<div class="viewcode-block" id="FASTPT.one_loop">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.one_loop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">one_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_simple</span><span class="o">.</span><span class="n">one_loop</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="FASTPT.P_bias">
<a class="viewcode-back" href="../../api.html#fastpt.FASTPT.P_bias">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">P_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_simple</span><span class="o">.</span><span class="n">P_bias</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="n">C_window</span><span class="p">)</span></div>


    <span class="c1">######################################################################################</span>
    <span class="c1">### Core functions used by top-level functions ###</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_fourier_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P_b</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache and return Fourier coefficients for a given biased power spectrum&quot;&quot;&quot;</span>
    
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;fourier_coefficients&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">P_b</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="n">hash_key</span> <span class="o">^</span> <span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">scalar</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x9e3779b9</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">hash_key</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fourier_coefficients&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">result</span>
    
        <span class="n">c_m_positive</span> <span class="o">=</span> <span class="n">rfft</span><span class="p">(</span><span class="n">P_b</span><span class="p">)</span>
        <span class="c1">#if scalar: c_m_positive[-1] = c_m_positive[-1] / 2. </span>
        <span class="n">c_m_negative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">c_m_positive</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">c_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">c_m_negative</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_m_positive</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">C_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;windowing the Fourier coefficients&#39;</span><span class="p">)</span>
            <span class="n">c_m</span> <span class="o">=</span> <span class="n">c_m</span> <span class="o">*</span> <span class="n">c_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">C_window</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">c_m</span><span class="p">,</span> <span class="s2">&quot;fourier_coefficients&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c_m</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cache_convolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_m</span><span class="p">,</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">h_l</span><span class="p">,</span> <span class="n">two_part_l</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cache and return convolution results&quot;&quot;&quot;</span>

        <span class="c1"># Use MurmurHash for faster hashing with low collision rate, original hashing method is much slower for this case</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">fast_hash</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                    <span class="n">sample</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[:</span><span class="mi">1000</span><span class="p">]</span>
                    <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        
        <span class="c1"># Combine hashes with different prime multipliers to reduce collisions</span>
        <span class="n">hash_key</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">primes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">257</span><span class="p">,</span> <span class="mi">509</span><span class="p">]</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">,</span> <span class="n">g_m</span><span class="p">,</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">h_l</span><span class="p">,</span> <span class="n">two_part_l</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arrays</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">fast_hash</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="n">hash_key</span> <span class="o">=</span> <span class="n">hash_key</span> <span class="o">^</span> <span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="n">primes</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">primes</span><span class="p">)])</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;convolution&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Calculate convolution</span>
        <span class="n">C_l</span> <span class="o">=</span> <span class="n">fftconvolve</span><span class="p">(</span><span class="n">c1</span> <span class="o">*</span> <span class="n">g_m</span><span class="p">,</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">g_n</span><span class="p">)</span>
        <span class="c1">#Old comments about C_l</span>
        <span class="c1"># C_l=convolve(c_m*self.g_m[i,:],c_m*self.g_n[i,:])</span>
        <span class="c1"># multiply all l terms together</span>
        <span class="c1"># C_l=C_l*self.h_l[i,:]*self.two_part_l[i]</span>
    
        <span class="c1"># Apply additional terms</span>
        <span class="k">if</span> <span class="n">two_part_l</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">C_l</span> <span class="o">=</span> <span class="n">C_l</span> <span class="o">*</span> <span class="n">h_l</span> <span class="o">*</span> <span class="n">two_part_l</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C_l</span> <span class="o">=</span> <span class="n">C_l</span> <span class="o">*</span> <span class="n">h_l</span>
        <span class="c1"># Cache and return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">C_l</span><span class="p">,</span> <span class="s2">&quot;convolution&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">C_l</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">J_k_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;J_k_scalar&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;J_k_scalar&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>

        <span class="n">pf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">g_m</span><span class="p">,</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">two_part_l</span><span class="p">,</span> <span class="n">h_l</span> <span class="o">=</span> <span class="n">X</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">extrap_P_low</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">extrap_P_high</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">P_b</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">P_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">P_b</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">c_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fourier_coefficients</span><span class="p">(</span><span class="n">P_b</span><span class="p">,</span> <span class="n">C_window</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">A_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_size</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c1"># convolve f_c and g_c</span>
            <span class="c1"># C_l=np.convolve(c_m*self.g_m[i,:],c_m*self.g_n[i,:])</span>
            <span class="n">C_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_convolution</span><span class="p">(</span><span class="n">c_m</span><span class="p">,</span> <span class="n">c_m</span><span class="p">,</span> <span class="n">g_m</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">g_n</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">h_l</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">two_part_l</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># set up to feed ifft an array ordered with l=0,1,...,-1,...,N/2-1</span>
            <span class="n">c_plus</span> <span class="o">=</span> <span class="n">C_l</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">c_minus</span> <span class="o">=</span> <span class="n">C_l</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">C_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">c_plus</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_minus</span><span class="p">))</span>
            <span class="n">A_k</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">C_l</span><span class="p">)</span> <span class="o">*</span> <span class="n">C_l</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># multiply by size to get rid of the normalization in ifft</span>

            <span class="n">A_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">A_k</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_final</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># note that you have to take every other element</span>
        <span class="c1"># in A_k, due to the extended array created from the</span>
        <span class="c1"># discrete convolution</span>

        <span class="n">P_out</span> <span class="o">=</span> <span class="n">irfft</span><span class="p">(</span><span class="n">c_m</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_final</span> <span class="o">**</span> <span class="n">nu</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># get rid of the elements created from padding</span>
            <span class="n">P_out</span> <span class="o">=</span> <span class="n">P_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_pad</span><span class="p">]</span>
            <span class="n">A_out</span> <span class="o">=</span> <span class="n">A_out</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_pad</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="n">P_out</span><span class="p">,</span> <span class="n">A_out</span><span class="p">),</span> <span class="s2">&quot;J_k_scalar&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_out</span><span class="p">,</span> <span class="n">A_out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">J_k_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_window</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_hash_key</span><span class="p">(</span><span class="s2">&quot;J_k_tensor&quot;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">P_window</span><span class="p">,</span> <span class="n">C_window</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;J_k_tensor&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">result</span>

        <span class="n">pf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">nu1</span><span class="p">,</span> <span class="n">nu2</span><span class="p">,</span> <span class="n">g_m</span><span class="p">,</span> <span class="n">g_n</span><span class="p">,</span> <span class="n">h_l</span> <span class="o">=</span> <span class="n">X</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">low_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">extrap_P_low</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high_extrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EK</span><span class="o">.</span><span class="n">extrap_P_high</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="n">A_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pf</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_size</span><span class="p">))</span>

        <span class="n">P_fin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_size</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pf</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>

            <span class="n">P_b1</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">nu1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">P_b2</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">nu2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">P_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># window the input power spectrum, so that at high and low k</span>
                <span class="c1"># the signal smoothly tappers to zero. This make the input</span>
                <span class="c1"># more &quot;like&quot; a periodic signal</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;windowing biased power spectrum&#39;</span><span class="p">)</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">p_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_extrap</span><span class="p">,</span> <span class="n">P_window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">P_window</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">P_b1</span> <span class="o">=</span> <span class="n">P_b1</span> <span class="o">*</span> <span class="n">W</span>
                <span class="n">P_b2</span> <span class="o">=</span> <span class="n">P_b2</span> <span class="o">*</span> <span class="n">W</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">P_b1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">P_b1</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">P_b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">P_b2</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">c_m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fourier_coefficients</span><span class="p">(</span><span class="n">P_b1</span><span class="p">,</span> <span class="n">C_window</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">c_n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_fourier_coefficients</span><span class="p">(</span><span class="n">P_b2</span><span class="p">,</span> <span class="n">C_window</span><span class="p">,</span> <span class="n">scalar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># convolve f_c and g_c</span>
            <span class="n">C_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache_convolution</span><span class="p">(</span><span class="n">c_m</span><span class="p">,</span> <span class="n">c_n</span><span class="p">,</span> <span class="n">g_m</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">g_n</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">h_l</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

            <span class="c1"># set up to feed ifft an array ordered with l=0,1,...,-1,...,N/2-1</span>
            <span class="n">c_plus</span> <span class="o">=</span> <span class="n">C_l</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">c_minus</span> <span class="o">=</span> <span class="n">C_l</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">C_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">c_plus</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">c_minus</span><span class="p">))</span>
            <span class="n">A_k</span> <span class="o">=</span> <span class="n">ifft</span><span class="p">(</span><span class="n">C_l</span><span class="p">)</span> <span class="o">*</span> <span class="n">C_l</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># multiply by size to get rid of the normalization in ifft</span>

            <span class="n">A_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">A_k</span><span class="p">[::</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">pf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_final</span> <span class="o">**</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="c1"># note that you have to take every other element</span>
            <span class="c1"># in A_k, due to the extended array created from the</span>
            <span class="c1"># discrete convolution</span>
            <span class="n">P_fin</span> <span class="o">+=</span> <span class="n">A_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="c1"># P_out=irfft(c_m[self.m&gt;=0])*self.k**self.nu*float(self.N)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># get rid of the elements created from padding</span>
            <span class="c1"># P_out=P_out[self.id_pad]</span>
            <span class="n">A_out</span> <span class="o">=</span> <span class="n">A_out</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_pad</span><span class="p">]</span>
            <span class="n">P_fin</span> <span class="o">=</span> <span class="n">P_fin</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_pad</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">((</span><span class="n">P_fin</span><span class="p">,</span> <span class="n">A_out</span><span class="p">),</span> <span class="s2">&quot;J_k_tensor&quot;</span><span class="p">,</span> <span class="n">hash_key</span><span class="p">,</span> <span class="n">P_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">P_fin</span><span class="p">,</span> <span class="n">A_out</span></div>





<span class="c1">#removed the original example, retrieve it from history if needed</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2025, FAST-PT developers.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>